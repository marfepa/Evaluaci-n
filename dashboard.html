<!DOCTYPE html>
<html lang="es">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control - Sistema de Evaluaci√≥n</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --shadow: rgba(0, 0, 0, 0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 2rem 2rem 3rem;
      box-shadow: 0 4px 6px -1px var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 300px;
      height: 300px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0) rotate(0deg);
      }

      50% {
        transform: translateY(-20px) rotate(10deg);
      }
    }

    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
    }

    .header p {
      opacity: 0.9;
      font-size: 1rem;
      position: relative;
      z-index: 1;
    }

    .container {
      max-width: 1400px;
      margin: -2rem auto 2rem;
      padding: 0 1rem;
      position: relative;
      z-index: 10;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: var(--card-bg);
      padding: 0.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px var(--shadow);
      overflow-x: auto;
    }

    .tab {
      padding: 0.875rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--text-light);
      cursor: pointer;
      border-radius: 8px;
      font-weight: 500;
      transition: var(--transition);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tab:hover {
      background: var(--bg);
      color: var(--text);
    }

    .tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--border);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px var(--shadow);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }

    .card-icon {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .card-icon.primary {
      background: linear-gradient(135deg, var(--primary-light), var(--primary));
      color: white;
    }

    .card-icon.secondary {
      background: linear-gradient(135deg, #34d399, var(--secondary));
      color: white;
    }

    .card-icon.success {
      background: linear-gradient(135deg, #34d399, #10b981);
      color: white;
    }

    .card-icon.warning {
      background: linear-gradient(135deg, #fbbf24, var(--warning));
      color: white;
    }

    .card-icon.danger {
      background: linear-gradient(135deg, #f87171, var(--danger));
      color: white;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text);
    }

    .card-description {
      color: var(--text-light);
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      justify-content: center;
      font-size: 0.9375rem;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary {
      background: var(--secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text);
      font-size: 0.9375rem;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: var(--transition);
      background: white;
      color: var(--text);
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 1.5rem;
      border-radius: 12px;
      border-left: 4px solid var(--primary);
      box-shadow: 0 2px 8px var(--shadow);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px var(--shadow);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      color: var(--text-light);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .alert {
      padding: 1rem 1.25rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: start;
      gap: 0.75rem;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid var(--secondary);
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid var(--danger);
    }

    .alert-info {
      background: #dbeafe;
      color: #1e40af;
      border-left: 4px solid var(--primary);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 2px 8px var(--shadow);
      background: var(--card-bg);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }

    th,
    td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    th {
      background: var(--bg);
      font-weight: 600;
      color: var(--text);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      color: var(--text-light);
    }

    tr:hover {
      background: var(--bg);
    }

    /* Attendance table specific styles */
    #attendanceTable {
      width: 100%;
      table-layout: fixed;
    }

    #attendanceTable thead th {
      position: sticky;
      top: 0;
      background: var(--bg);
      z-index: 10;
    }

    #attendanceStudentsTable tr {
      display: table-row;
    }

    #attendanceStudentsTable td {
      display: table-cell;
      vertical-align: middle;
      padding: 0.75rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    #attendanceStudentsTable td:first-child {
      text-align: left;
      padding: 0.75rem;
    }

    #attendanceStudentsTable input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--primary);
      margin: 0 auto;
      display: block;
    }

    #attendanceStudentsTable input[type="checkbox"]:hover {
      transform: scale(1.15);
    }

    .badge {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .badge-primary {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--secondary);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-light);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-content {
      background: var(--card-bg);
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: scaleIn 0.3s ease-out;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
      transition: var(--transition);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }

    .modal-close:hover {
      background: var(--bg);
      color: var(--text);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    /* Evaluation Panel Styles */
    .evaluation-panel {
      position: fixed;
      top: 0;
      right: -600px;
      width: 600px;
      max-width: 90vw;
      height: 100vh;
      background: var(--card-bg);
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }

    .evaluation-panel.active {
      right: 0;
    }

    .evaluation-panel-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .evaluation-panel-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .evaluation-panel-header {
      padding: 1.5rem;
      border-bottom: 2px solid var(--border);
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .evaluation-panel-header button {
      color: white !important;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .evaluation-panel-header button:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.1) !important;
    }

    .evaluation-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .evaluation-criterion {
      background: var(--bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    .evaluation-criterion:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }

    .evaluation-criterion-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--text);
      font-size: 0.95rem;
    }

    .evaluation-levels {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .evaluation-level {
      position: relative;
    }

    .evaluation-level input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .evaluation-level label {
      display: block;
      padding: 0.75rem;
      text-align: center;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .evaluation-level input[type="radio"]:checked+label {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .evaluation-level label:hover {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }

    .evaluation-notes {
      margin-top: 1rem;
    }

    .evaluation-notes textarea {
      width: 100%;
      min-height: 80px;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.875rem;
      resize: vertical;
      transition: var(--transition);
    }

    .evaluation-notes textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Evaluation Mode Tabs */
    .evaluation-mode-tab {
      position: relative;
    }

    .evaluation-mode-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary) !important;
    }

    .evaluation-mode-content {
      animation: fadeIn 0.3s ease-out;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.5rem;
      }

      .container {
        margin-top: -1rem;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .tabs {
        overflow-x: auto;
      }

      .stat-value {
        font-size: 1.5rem;
      }
    }

    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .5;
      }
    }

    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
      border-radius: 4px;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: var(--primary);
      border-radius: 4px;
    }

    .checkbox-wrapper input[type="checkbox"]:hover {
      transform: scale(1.1);
      transition: transform 0.2s ease;
    }

    .student-row {
      transition: var(--transition);
      border-bottom: 1px solid var(--border);
    }

    .student-row:hover {
      background: rgba(37, 99, 235, 0.02) !important;
    }

    .student-row.present {
      background: rgba(16, 185, 129, 0.08);
      border-left: 3px solid var(--secondary);
    }

    .student-row.present:hover {
      background: rgba(16, 185, 129, 0.12) !important;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>üìä Panel de Control de Evaluaci√≥n</h1>
    <p>Sistema integral de gesti√≥n educativa</p>
    <div id="modeIndicator"
      style="position: absolute; top: 1rem; right: 1rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 0.875rem; display: none;">
    </div>
  </div>

  <div class="container">
    <!-- Navigation Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="overview">üìà Resumen</button>
      <button class="tab" data-tab="students">üë• Estudiantes</button>
      <button class="tab" data-tab="evaluate">‚úÖ Evaluar</button>
      <button class="tab" data-tab="attendance">üìã Asistencia</button>
      <button class="tab" data-tab="grades">üìù Calificaciones</button>
      <button class="tab" data-tab="instruments">üéØ Instrumentos</button>
      <button class="tab" data-tab="reports">üìä Reportes</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats-container" id="statsContainer">
        <div class="stat-card">
          <div class="stat-value" id="totalStudents">0</div>
          <div class="stat-label">Estudiantes</div>
        </div>
        <div class="stat-card" style="border-left-color: var(--secondary);">
          <div class="stat-value" style="color: var(--secondary);" id="totalCourses">0</div>
          <div class="stat-label">Cursos</div>
        </div>
        <div class="stat-card" style="border-left-color: var(--warning);">
          <div class="stat-value" style="color: var(--warning);" id="totalInstruments">0</div>
          <div class="stat-label">Instrumentos</div>
        </div>
        <div class="stat-card" style="border-left-color: var(--danger);">
          <div class="stat-value" style="color: var(--danger);" id="totalGrades">0</div>
          <div class="stat-label">Evaluaciones</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-icon primary">üë•</div>
            <div>
              <div class="card-title">Gesti√≥n de Estudiantes</div>
            </div>
          </div>
          <div class="card-description">
            Administra la informaci√≥n de los estudiantes, cursos y grupos.
          </div>
          <button class="btn btn-primary" onclick="switchTab('students')">
            Ver Estudiantes ‚Üí
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon secondary">üìã</div>
            <div>
              <div class="card-title">Control de Asistencia</div>
            </div>
          </div>
          <div class="card-description">
            Registra y consulta la asistencia de los estudiantes.
          </div>
          <button class="btn btn-secondary" onclick="switchTab('attendance')">
            Ver Asistencia ‚Üí
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon warning">üìù</div>
            <div>
              <div class="card-title">Calificaciones</div>
            </div>
          </div>
          <div class="card-description">
            Consulta y analiza las calificaciones de los estudiantes.
          </div>
          <button class="btn btn-outline" onclick="switchTab('grades')">
            Ver Calificaciones ‚Üí
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon danger">üéØ</div>
            <div>
              <div class="card-title">Instrumentos de Evaluaci√≥n</div>
            </div>
          </div>
          <div class="card-description">
            Gestiona r√∫bricas, listas de cotejo y otros instrumentos.
          </div>
          <button class="btn btn-outline" onclick="switchTab('instruments')">
            Ver Instrumentos ‚Üí
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üîó</div>
            <div>
              <div class="card-title">Herramienta Externa</div>
            </div>
          </div>
          <div class="card-description">
            Accede a recursos y herramientas complementarias.
          </div>
          <button class="btn btn-outline" onclick="abrirEnlaceExternoDashboard()">
            Abrir Herramienta ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Students Tab -->
    <div id="students" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-icon primary">üë•</div>
          <div>
            <div class="card-title">Estudiantes Registrados</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Filtrar por curso</label>
          <select class="form-select" id="studentCourseFilter" onchange="loadStudents()">
            <option value="">Todos los cursos</option>
          </select>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Curso</th>
                <th>Email</th>
              </tr>
            </thead>
            <tbody id="studentsTable">
              <tr>
                <td colspan="4">
                  <div class="empty-state">
                    <div class="empty-state-icon">üë§</div>
                    <div>Cargando estudiantes...</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Evaluate Tab -->
    <div id="evaluate" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div class="card-icon success">‚úÖ</div>
          <div>
            <div class="card-title">Evaluaci√≥n de Estudiantes</div>
            <div class="card-description">Selecciona el modo de evaluaci√≥n</div>
          </div>
        </div>

        <!-- Mode Selection Tabs -->
        <div
          style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 0;">
          <button id="newEvaluationModeBtn" class="evaluation-mode-tab active" onclick="switchEvaluationMode('new')"
            style="flex: 1; padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s;">
            üìù Nueva Evaluaci√≥n
          </button>
          <button id="reviewEvaluationModeBtn" class="evaluation-mode-tab" onclick="switchEvaluationMode('review')"
            style="flex: 1; padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s;">
            üîç Revisar Evaluaciones
          </button>
        </div>

        <!-- NEW EVALUATION MODE -->
        <div id="newEvaluationMode" class="evaluation-mode-content">
          <!-- Selecci√≥n de Curso y R√∫brica -->
          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">Curso</label>
              <select class="form-select" id="evaluateCourseSelect" onchange="onEvaluateCourseChange()">
                <option value="">Selecciona un curso...</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">R√∫brica/Instrumento</label>
              <select class="form-select" id="evaluateInstrumentSelect" onchange="onEvaluateInstrumentChange()">
                <option value="">Primero selecciona un curso...</option>
              </select>
            </div>
          </div>

          <!-- Informaci√≥n del instrumento seleccionado -->
          <div id="evaluateInstrumentInfo"
            style="display: none; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--secondary);">
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--secondary);">üìã Instrumento seleccionado
            </div>
            <div id="evaluateInstrumentDetails" style="font-size: 0.875rem; color: var(--text-light);"></div>
          </div>

          <!-- Lista de Estudiantes -->
          <div id="evaluateStudentsList" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <label class="form-label" style="margin-bottom: 0;">
                Selecciona estudiantes para evaluar
                <span style="color: var(--text-light); font-size: 0.875rem; font-weight: 400;">(selecci√≥n m√∫ltiple para
                  evaluaci√≥n grupal)</span>
              </label>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                  onclick="selectAllStudents()">
                  ‚úì Seleccionar Todos
                </button>
                <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                  onclick="clearStudentSelection()">
                  ‚úó Limpiar Selecci√≥n
                </button>
              </div>
            </div>

            <!-- Estudiantes ya evaluados -->
            <div id="evaluatedStudentsInfo"
              style="display: none; padding: 0.75rem; background: rgba(37, 99, 235, 0.1); border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem;">
              <strong>‚ÑπÔ∏è Estudiantes evaluados:</strong> <span id="evaluatedStudentsText"></span>
            </div>

            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
              <table id="evaluateStudentsTable" style="width: 100%; border-collapse: collapse;">
                <thead
                  style="position: sticky; top: 0; background: var(--bg); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <tr>
                    <th style="width: 50px; text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">
                      <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllStudents()"
                        style="width: 18px; height: 18px; cursor: pointer;">
                    </th>
                    <th style="text-align: left; padding: 1rem; border-bottom: 2px solid var(--border);">Estudiante</th>
                    <th style="text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">Estado</th>
                    <th
                      style="width: 150px; text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">
                      Acciones</th>
                  </tr>
                </thead>
                <tbody id="evaluateStudentsTableBody">
                </tbody>
              </table>
            </div>

            <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem; align-items: center;">
              <button class="btn btn-primary" onclick="openEvaluationPanel()" id="openEvaluationBtn" disabled>
                üìù Abrir Panel de Evaluaci√≥n
              </button>
              <span id="selectedStudentsCount" style="color: var(--text-light); font-size: 0.875rem;"></span>
            </div>
          </div>
        </div>

        <!-- REVIEW EVALUATION MODE -->
        <div id="reviewEvaluationMode" class="evaluation-mode-content" style="display: none;">
          <!-- Selecci√≥n de Curso y R√∫brica para revisar -->
          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">Curso</label>
              <select class="form-select" id="reviewCourseSelect" onchange="onReviewCourseChange()">
                <option value="">Selecciona un curso...</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label">R√∫brica/Instrumento</label>
              <select class="form-select" id="reviewInstrumentSelect" onchange="onReviewInstrumentChange()">
                <option value="">Primero selecciona un curso...</option>
              </select>
            </div>
          </div>

          <!-- Informaci√≥n del instrumento para revisar -->
          <div id="reviewInstrumentInfo"
            style="display: none; padding: 1rem; background: rgba(37, 99, 235, 0.1); border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary);">
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">üìã Instrumento seleccionado
            </div>
            <div id="reviewInstrumentDetails" style="font-size: 0.875rem; color: var(--text-light);"></div>
          </div>

          <!-- Tabla de evaluaciones registradas -->
          <div id="reviewEvaluationsList" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <label class="form-label" style="margin-bottom: 0;">
                Evaluaciones Registradas
                <span id="reviewEvaluationsCount"
                  style="color: var(--text-light); font-size: 0.875rem; font-weight: 400;"></span>
              </label>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="text" id="reviewSearchInput" placeholder="Buscar estudiante..."
                  onkeyup="filterReviewEvaluations()"
                  style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem;">
                <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                  onclick="loadReviewEvaluations()">
                  üîÑ Recargar
                </button>
              </div>
            </div>

            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
              <table id="reviewEvaluationsTable" style="width: 100%; border-collapse: collapse;">
                <thead
                  style="position: sticky; top: 0; background: var(--bg); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <tr>
                    <th style="text-align: left; padding: 1rem; border-bottom: 2px solid var(--border);">Estudiante</th>
                    <th style="text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">Calificaci√≥n
                    </th>
                    <th style="text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">Fecha</th>
                    <th
                      style="width: 200px; text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">
                      Acciones</th>
                  </tr>
                </thead>
                <tbody id="reviewEvaluationsTableBody">
                </tbody>
              </table>
            </div>
          </div>

          <!-- Empty state -->
          <div id="reviewEmptyState"
            style="display: none; text-align: center; padding: 3rem; color: var(--text-light);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">No hay evaluaciones registradas
            </div>
            <div style="font-size: 0.875rem;">Selecciona un curso e instrumento con evaluaciones ya realizadas</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Tab -->
    <div id="attendance" class="tab-content">
      <!-- Quick Attendance Registration -->
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
          <div class="card-icon primary">‚úèÔ∏è</div>
          <div>
            <div class="card-title">Registrar Asistencia R√°pida</div>
          </div>
        </div>
        <div class="card-description">
          Registro r√°pido de asistencia para un curso.
        </div>

        <div class="form-group">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-input" id="attendanceDate" required>
        </div>

        <div class="form-group">
          <label class="form-label">Curso</label>
          <select class="form-select" id="attendanceCourseSelect" onchange="loadStudentsForAttendance()" required>
            <option value="">Selecciona un curso...</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Colegio</label>
          <select class="form-select" id="attendanceSchoolSelect" required>
            <option value="">Selecciona un colegio...</option>
          </select>
        </div>

        <div id="attendanceStudentsList" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <label class="form-label" style="margin-bottom: 0;">Estudiantes</label>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                onclick="markAllPresent()">
                ‚úì Todos Presentes
              </button>
              <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                onclick="clearAllAttendance()">
                ‚úó Limpiar Todo
              </button>
            </div>
          </div>

          <div class="table-container" style="max-height: 500px; overflow-y: auto;">
            <table id="attendanceTable" style="width: 100%; table-layout: fixed; border-collapse: collapse;">
              <thead
                style="position: sticky; top: 0; background: var(--bg); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <tr>
                  <th style="width: 40%; text-align: left; padding: 1rem; border-bottom: 2px solid var(--border);">
                    Estudiante</th>
                  <th style="width: 15%; text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">
                    Presente</th>
                  <th style="width: 15%; text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">
                    Retraso</th>
                  <th style="width: 15%; text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">Sin
                    Uniforme</th>
                  <th style="width: 15%; text-align: center; padding: 1rem; border-bottom: 2px solid var(--border);">Sin
                    Aseo</th>
                </tr>
              </thead>
              <tbody id="attendanceStudentsTable">
              </tbody>
            </table>
          </div>

          <div style="margin-top: 1.5rem; display: flex; gap: 0.75rem;">
            <button class="btn btn-primary" onclick="saveAttendanceBatch()">
              üíæ Guardar Asistencia
            </button>
            <button class="btn btn-outline" onclick="cancelAttendanceRegistration()">
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- Recent Attendance Records -->
      <div class="card" style="margin-bottom: 1.5rem; display: none;" id="recentAttendanceCard">
        <div class="card-header">
          <div class="card-icon secondary">üìã</div>
          <div>
            <div class="card-title">Registros Recientes</div>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Estudiante</th>
                <th>Curso</th>
                <th>Presente</th>
                <th>Observaciones</th>
              </tr>
            </thead>
            <tbody id="recentAttendanceTable">
              <tr>
                <td colspan="5">
                  <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <div>No hay registros recientes</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Attendance Reports -->
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-icon secondary">üìä</div>
            <div>
              <div class="card-title">Reporte por Estudiante</div>
            </div>
          </div>
          <div class="card-description">
            Genera un reporte detallado de asistencia individual.
          </div>
          <button class="btn btn-primary" onclick="showAttendanceStudentModal()">
            Generar Reporte
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon secondary">üìö</div>
            <div>
              <div class="card-title">Reporte por Curso</div>
            </div>
          </div>
          <div class="card-description">
            Visualiza la asistencia completa de un curso.
          </div>
          <button class="btn btn-primary" onclick="showAttendanceCourseModal()">
            Generar Reporte
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon warning">üîÑ</div>
            <div>
              <div class="card-title">Comparar Estudiantes</div>
            </div>
          </div>
          <div class="card-description">
            Compara la asistencia entre dos estudiantes.
          </div>
          <button class="btn btn-secondary" onclick="compareStudents()">
            Comparar
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon warning">üîÑ</div>
            <div>
              <div class="card-title">Comparar Cursos</div>
            </div>
          </div>
          <div class="card-description">
            Compara la asistencia entre dos cursos.
          </div>
          <button class="btn btn-secondary" onclick="compareCourses()">
            Comparar
          </button>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <div class="card-icon danger">üîî</div>
          <div>
            <div class="card-title">Automatizaci√≥n de Alertas</div>
          </div>
        </div>
        <div class="card-description">
          Configura alertas autom√°ticas por email sobre asistencia.
        </div>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
          <button class="btn btn-outline" onclick="openSchedulerDialog()">
            ‚è∞ Programar Alertas
          </button>
          <button class="btn btn-outline" onclick="openConfigDialog()">
            ‚öôÔ∏è Configurar Alertas
          </button>
          <button class="btn btn-outline" onclick="diagnosticarSistema()">
            üîç Diagnosticar
          </button>
        </div>
      </div>
    </div>

    <!-- Grades Tab -->
    <div id="grades" class="tab-content">
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-icon primary">üë§</div>
            <div>
              <div class="card-title">Calificaciones por Estudiante</div>
            </div>
          </div>
          <div class="card-description">
            Consulta todas las calificaciones de un estudiante.
          </div>
          <button class="btn btn-primary" onclick="showGradesStudentModal()">
            Ver Calificaciones
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon primary">üìö</div>
            <div>
              <div class="card-title">Calificaciones por Curso</div>
            </div>
          </div>
          <div class="card-description">
            Visualiza todas las calificaciones de un curso.
          </div>
          <button class="btn btn-primary" onclick="showGradesCourseModal()">
            Ver Calificaciones
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon secondary">üîÑ</div>
            <div>
              <div class="card-title">Comparar Estudiantes</div>
            </div>
          </div>
          <div class="card-description">
            Compara calificaciones entre dos estudiantes.
          </div>
          <button class="btn btn-secondary" onclick="compareGradesStudents()">
            Comparar
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon secondary">üîÑ</div>
            <div>
              <div class="card-title">Comparar Cursos</div>
            </div>
          </div>
          <div class="card-description">
            Compara calificaciones entre dos cursos.
          </div>
          <button class="btn btn-secondary" onclick="compareGradesCourses()">
            Comparar
          </button>
        </div>
      </div>
    </div>

    <!-- Instruments Tab -->
    <div id="instruments" class="tab-content">
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
          <div class="card-icon warning">üéØ</div>
          <div>
            <div class="card-title">Instrumentos de Evaluaci√≥n</div>
          </div>
        </div>

        <!-- Filtros -->
        <div
          style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Filtrar por curso</label>
            <select class="form-select" id="instrumentCourseFilter" onchange="onCourseFilterChange()">
              <option value="">Todos los cursos</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Filtrar por situaci√≥n</label>
            <select class="form-select" id="instrumentSituationFilter" onchange="loadInstruments()">
              <option value="">Todas las situaciones</option>
            </select>
          </div>

          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Filtrar por tipo</label>
            <select class="form-select" id="instrumentTypeFilter" onchange="loadInstruments()">
              <option value="">Todos los tipos</option>
              <option value="R√∫brica">R√∫brica</option>
              <option value="Lista de Cotejo">Lista de Cotejo</option>
              <option value="Calificaci√≥n Directa">Calificaci√≥n Directa</option>
            </select>
          </div>
        </div>

        <!-- Informaci√≥n de filtrado -->
        <div id="instrumentsFilterInfo"
          style="display: none; padding: 0.75rem; background: rgba(37, 99, 235, 0.1); border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem; color: var(--primary);">
          <strong>üìå Filtros activos:</strong> <span id="instrumentsFilterText"></span>
          <button onclick="clearInstrumentFilters()"
            style="background: none; border: none; color: var(--primary); cursor: pointer; text-decoration: underline; margin-left: 0.5rem;">Limpiar
            filtros</button>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Curso</th>
                <th>Situaci√≥n</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="instrumentsTable">
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <div class="empty-state-icon">üéØ</div>
                    <div>Cargando instrumentos...</div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div id="reports" class="tab-content">
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-icon primary">üìÑ</div>
            <div>
              <div class="card-title">Reporte de Notas por Situaci√≥n</div>
            </div>
          </div>
          <div class="card-description">
            Genera un informe detallado de calificaciones por situaci√≥n de aprendizaje.
          </div>
          <button class="btn btn-primary" onclick="generateSituationReport()">
            Generar Reporte
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon secondary">üìä</div>
            <div>
              <div class="card-title">Reporte Avanzado de Asistencia</div>
            </div>
          </div>
          <div class="card-description">
            An√°lisis avanzado con m√∫ltiples filtros y opciones.
          </div>
          <button class="btn btn-secondary" onclick="generateAdvancedAttendanceReport()">
            Generar Reporte
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon warning">üßÆ</div>
            <div>
              <div class="card-title">Calcular Medias Ponderadas</div>
            </div>
          </div>
          <div class="card-description">
            Asigna pesos a instrumentos y calcula la media ponderada.
          </div>
          <button class="btn btn-outline" onclick="calculateWeightedAverage()">
            Calcular
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon danger">üìà</div>
            <div>
              <div class="card-title">Exportar Datos</div>
            </div>
          </div>
          <div class="card-description">
            Exporta reportes y datos en diferentes formatos.
          </div>
          <button class="btn btn-outline" onclick="exportData()">
            Exportar
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-icon success">üìã</div>
            <div>
              <div class="card-title">Consultar Reportes Existentes</div>
            </div>
          </div>
          <div class="card-description">
            Visualiza reportes ya generados sin duplicar informaci√≥n.
          </div>
          <button class="btn btn-success" onclick="viewExistingReports()">
            Listar Reportes
          </button>
        </div>
      </div>

      <!-- √Årea para mostrar la lista de reportes existentes -->
      <div id="reportes-existentes-container" style="margin-top: 24px; display: none;">
        <div class="card" style="max-width: 100%;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 1.3em;">üìä</span>
                <span>Reportes Existentes</span>
              </h3>
              <span id="reportes-badge"
                style="background: #f1f5f9; padding: 6px 12px; border-radius: 8px; font-size: 0.875em; font-weight: 600; color: #64748b;">
                0 reportes
              </span>
            </div>
            <button class="btn btn-outline" onclick="ocultarListaReportes()" style="padding: 8px 16px;">
              ‚úï Ocultar
            </button>
          </div>
          <div class="card-body" style="padding: 20px;">
            <div id="reportes-search-container" style="margin-bottom: 20px; display: none;">
              <input type="text" id="search-reportes-dashboard" class="form-input"
                placeholder="üîç Buscar reportes por nombre, curso o situaci√≥n..."
                style="width: 100%; padding: 10px 12px; font-size: 0.9em;" />
            </div>
            <div id="reportes-lista-dashboard">
              <!-- La lista de reportes se insertar√° aqu√≠ -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Student Selection -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="studentModalTitle">Seleccionar Estudiante</h3>
        <button class="modal-close" onclick="closeModal('studentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ID del Estudiante</label>
          <input type="text" class="form-input" id="studentIdInput" placeholder="Ingresa el ID del estudiante">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('studentModal')">Cancelar</button>
        <button class="btn btn-primary" id="studentModalConfirm">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal for Course Selection -->
  <div id="courseModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="courseModalTitle">Seleccionar Curso</h3>
        <button class="modal-close" onclick="closeModal('courseModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ID del Curso</label>
          <input type="text" class="form-input" id="courseIdInput" placeholder="Ingresa el ID del curso">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('courseModal')">Cancelar</button>
        <button class="btn btn-primary" id="courseModalConfirm">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal for Comparison -->
  <div id="comparisonModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="comparisonModalTitle">Comparar</h3>
        <button class="modal-close" onclick="closeModal('comparisonModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" id="comparisonLabel1">Primer ID</label>
          <input type="text" class="form-input" id="comparisonInput1" placeholder="Ingresa el primer ID">
        </div>
        <div class="form-group">
          <label class="form-label" id="comparisonLabel2">Segundo ID</label>
          <input type="text" class="form-input" id="comparisonInput2" placeholder="Ingresa el segundo ID">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('comparisonModal')">Cancelar</button>
        <button class="btn btn-primary" id="comparisonModalConfirm">Comparar</button>
      </div>
    </div>
  </div>

  <!-- Modal for Report Results -->
  <div id="reportResultsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <h3 class="modal-title" id="reportResultsTitle">Resultados del Reporte</h3>
        <button class="modal-close" onclick="closeModal('reportResultsModal')">&times;</button>
      </div>
      <div class="modal-body" id="reportResultsBody">
        <!-- Results will be inserted here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('reportResultsModal')">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Evaluation Side Panel -->
  <div id="evaluationPanel" class="evaluation-panel">
    <div class="evaluation-panel-header">
      <div style="flex: 1;">
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Panel de Evaluaci√≥n</h3>
        <p id="evaluationPanelSubtitle" style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--text-light);">
        </p>
      </div>
      <button onclick="closeEvaluationPanel()"
        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); padding: 0.25rem; line-height: 1;">√ó</button>
    </div>

    <div class="evaluation-panel-content">
      <!-- Student Selection Info -->
      <div id="evaluationStudentsInfo"
        style="padding: 1rem; background: rgba(37, 99, 235, 0.1); border-radius: 8px; margin-bottom: 1.5rem;">
        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">Evaluando a:</div>
        <div id="evaluationStudentsList" style="font-size: 0.875rem;"></div>
      </div>

      <!-- Evaluation Form -->
      <div id="evaluationForm">
        <!-- Dynamic content will be inserted here based on instrument type -->
      </div>

      <!-- Action Buttons -->
      <div
        style="display: flex; gap: 0.75rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--border); position: sticky; bottom: 0; background: white;">
        <button class="btn btn-outline" onclick="duplicateEvaluation()" id="duplicateBtn" style="flex: 1;">
          üìã Duplicar a otro alumno
        </button>
        <button class="btn btn-primary" onclick="saveEvaluation()" id="saveEvaluationBtn" style="flex: 2;">
          üíæ Guardar Evaluaci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- Panel Overlay -->
  <div id="evaluationPanelOverlay" class="evaluation-panel-overlay" onclick="closeEvaluationPanel()"></div>

  <script>
    // ============================================================================
    // CONTEXT DETECTION AND API WRAPPER
    // ============================================================================

    // Detect if running in modal (google.script.run available) or web app mode
    // Verificaci√≥n m√°s robusta para detectar el modo correctamente
    const isModalMode = (function () {
      try {
        return typeof google !== 'undefined' &&
          google.script &&
          typeof google.script.run !== 'undefined';
      } catch (e) {
        return false;
      }
    })();
    const isWebAppMode = !isModalMode;

    // Store webapp URL if in web app mode
    let webAppUrl = window.location.origin + window.location.pathname;

    console.log('Dashboard Mode:', isModalMode ? 'Modal Dialog' : 'Web App');
    console.log('User Agent:', navigator.userAgent);
    console.log('Window location:', window.location.href);

    /**
     * Universal API call wrapper that works in both modal and web app modes
     * @param {string} functionName - Backend function name to call
     * @param {Array} args - Arguments to pass to the function
     * @returns {Promise} - Promise that resolves with the response
     */
    function callBackend(functionName, ...args) {
      console.log(`üîß [callBackend] Llamando a "${functionName}" con args:`, args);
      console.log(`üîß [callBackend] Modo: ${isModalMode ? 'Modal' : 'Web App'}`);

      return new Promise((resolve, reject) => {
        if (isModalMode) {
          // Modal mode: use google.script.run
          try {
            console.log(`üìû [callBackend] Ejecutando google.script.run.${functionName}()`);
            google.script.run
              .withSuccessHandler(function (result) {
                console.log(`‚úÖ [callBackend] Success: ${functionName}`, result);
                console.log(`‚úÖ [callBackend] Tipo de resultado:`, typeof result);
                console.log(`‚úÖ [callBackend] Keys:`, result ? Object.keys(result) : 'null');
                resolve(result);
              })
              .withFailureHandler(function (error) {
                console.error(`‚ùå [callBackend] Error calling ${functionName}:`, error);
                reject(new Error(error.message || error.toString()));
              })
            [functionName](...args);
          } catch (error) {
            console.error(`‚ùå [callBackend] Exception calling ${functionName}:`, error);
            reject(error);
          }
        } else {
          // Web app mode: use fetch to call the backend
          console.log(`üåê [callBackend] Calling ${functionName} via POST to ${webAppUrl}`, args);
          fetch(webAppUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              function: functionName,
              arguments: args
            }),
            mode: 'cors',
            credentials: 'include'
          })
            .then(response => {
              console.log(`üì• [callBackend] Response status:`, response.status, response.statusText);
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              return response.json();
            })
            .then(data => {
              console.log(`‚úÖ [callBackend] Response from ${functionName}:`, data);
              console.log(`‚úÖ [callBackend] data.error:`, data.error);
              console.log(`‚úÖ [callBackend] data.result:`, data.result);
              console.log(`‚úÖ [callBackend] Tipo de data.result:`, typeof data.result);
              if (data.error) {
                reject(new Error(data.error));
              } else {
                resolve(data.result);
              }
            })
            .catch(error => {
              console.error(`‚ùå [callBackend] Fetch error calling ${functionName}:`, error);
              reject(error);
            });
        }
      });
    }

    /**
     * Show loading overlay
     */
    function showLoading(message = 'Cargando...') {
      let overlay = document.getElementById('loadingOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          z-index: 9999;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-direction: column;
          color: white;
          font-size: 1.2rem;
        `;
        overlay.innerHTML = `
          <div class="loading" style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white;"></div>
          <div style="margin-top: 1rem;" id="loadingMessage">${message}</div>
        `;
        document.body.appendChild(overlay);
      } else {
        overlay.style.display = 'flex';
        document.getElementById('loadingMessage').textContent = message;
      }
    }

    /**
     * Hide loading overlay
     */
    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    /**
     * Show user-friendly error message
     */
    function showError(message, details = '') {
      hideLoading();
      const errorHtml = `
        <div class="alert alert-error" style="margin: 1rem;">
          <div style="font-weight: 600;">‚ùå Error</div>
          <div>${message}</div>
          ${details ? `<div style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.8;">${details}</div>` : ''}
        </div>
      `;

      // Try to show in current tab content
      const activeTab = document.querySelector('.tab-content.active');
      if (activeTab) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = errorHtml;
        activeTab.insertBefore(tempDiv.firstElementChild, activeTab.firstChild);

        // Auto-remove after 5 seconds
        setTimeout(() => tempDiv.firstElementChild?.remove(), 5000);
      } else {
        alert(message + (details ? '\n\n' + details : ''));
      }
    }

    /**
     * Show success message
     */
    function showSuccess(message) {
      hideLoading();
      const successHtml = `
        <div class="alert alert-success" style="margin: 1rem;">
          <div>‚úÖ ${message}</div>
        </div>
      `;

      const activeTab = document.querySelector('.tab-content.active');
      if (activeTab) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = successHtml;
        activeTab.insertBefore(tempDiv.firstElementChild, activeTab.firstChild);

        // Auto-remove after 3 seconds
        setTimeout(() => tempDiv.firstElementChild?.remove(), 3000);
      } else {
        alert('‚úÖ ' + message);
      }
    }

    /**
     * Show report results in modal
     */
    function showReportResults(title, data) {
      document.getElementById('reportResultsTitle').textContent = title;
      const body = document.getElementById('reportResultsBody');

      if (Array.isArray(data)) {
        // Display as table
        if (data.length === 0) {
          body.innerHTML = '<div class="alert alert-info">No hay datos para mostrar</div>';
        } else {
          const keys = Object.keys(data[0]);
          body.innerHTML = `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    ${keys.map(k => `<th>${k}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${data.map(row => `
                    <tr>
                      ${keys.map(k => `<td>${row[k] !== null && row[k] !== undefined ? row[k] : '-'}</td>`).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      } else if (typeof data === 'object') {
        // Display as key-value pairs
        body.innerHTML = `
          <div class="table-container">
            <table>
              <tbody>
                ${Object.entries(data).map(([key, value]) => `
                  <tr>
                    <th style="width: 40%; text-align: left;">${key}</th>
                    <td>${value !== null && value !== undefined ? value : '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } else {
        body.innerHTML = `<div class="alert alert-info">${data}</div>`;
      }

      showModal('reportResultsModal');
    }

    // ============================================================================
    // TAB MANAGEMENT
    // ============================================================================

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        switchTab(tabId);
      });
    });

    function switchTab(tabId) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

      // Update content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');

      // Load data for the tab
      loadTabData(tabId);
    }

    function abrirEnlaceExternoDashboard() {
      const url = 'https://script.google.com/a/macros/scorazon.hhdc.net/s/AKfycbysSeb9LlsIQ48K5LemLoPh8a_5BaiLXKp7hSd7HOG7nQwWP3NVn7NMwAKTG9nnmCfD/exec';
      window.open(url, '_blank');
    }

    function loadTabData(tabId) {
      switch (tabId) {
        case 'overview':
          loadStats();
          break;
        case 'students':
          loadStudents();
          loadCourses();
          break;
        case 'evaluate':
          loadEvaluationCourses();
          break;
        case 'attendance':
          // Set today's date
          const today = new Date().toISOString().split('T')[0];
          document.getElementById('attendanceDate').value = today;
          // Load dropdowns
          loadAttendanceDropdowns();
          loadRecentAttendance();
          break;
        case 'instruments':
          loadInstruments();
          break;
      }
    }

    // ============================================================================
    // DATA LOADING FUNCTIONS
    // ============================================================================

    // Load statistics
    async function loadStats() {
      try {
        const data = await callBackend('getStatistics');
        document.getElementById('totalStudents').textContent = data.students || 0;
        document.getElementById('totalCourses').textContent = data.courses || 0;
        document.getElementById('totalInstruments').textContent = data.instruments || 0;
        document.getElementById('totalGrades').textContent = data.grades || 0;
      } catch (err) {
        console.error('Error loading stats:', err);
        showError('Error al cargar estad√≠sticas', err.message);
      }
    }

    // Load students
    async function loadStudents() {
      const courseFilter = document.getElementById('studentCourseFilter').value;
      const tbody = document.getElementById('studentsTable');

      tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><div class="loading"></div><div>Cargando...</div></div></td></tr>';

      try {
        const students = await callBackend('getEstudiantesData');

        if (!students || students.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4"><div class="empty-state"><div class="empty-state-icon">üë§</div><div>No hay estudiantes registrados</div></div></td></tr>';
          return;
        }

        let filtered = students;
        if (courseFilter) {
          filtered = students.filter(s => s.CursoID === courseFilter);
        }

        tbody.innerHTML = filtered.map(student => `
          <tr>
            <td>${student.IDEstudiante || '-'}</td>
            <td>${student.NombreEstudiante || '-'}</td>
            <td><span class="badge badge-primary">${student.CursoID || '-'}</span></td>
            <td>${student.Email || '-'}</td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading students:', err);
        tbody.innerHTML = '<tr><td colspan="4"><div class="alert alert-error">Error al cargar estudiantes</div></td></tr>';
      }
    }

    // Load courses for filter
    async function loadCourses() {
      try {
        const courses = await callBackend('getCourses');
        const select = document.getElementById('studentCourseFilter');
        const current = select.value;
        select.innerHTML = '<option value="">Todos los cursos</option>' +
          courses.map(c => `<option value="${c}">${c}</option>`).join('');
        select.value = current;
      } catch (err) {
        console.error('Error loading courses:', err);
      }
    }

    // Cache for instruments data (to avoid refetching on filter changes)
    let cachedInstruments = null;

    // Load instruments with filtering support
    async function loadInstruments(skipFetch = false) {
      const tbody = document.getElementById('instrumentsTable');
      tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="loading"></div><div>Cargando...</div></div></td></tr>';

      try {
        // Use cached data if available and skipFetch is true
        let instruments;
        if (skipFetch && cachedInstruments) {
          instruments = cachedInstruments;
          console.log('üì¶ Usando instrumentos en cach√©');
        } else {
          instruments = await callBackend('getInstrumentosData');
          cachedInstruments = instruments; // Cache for future use
          console.log('üìä Instrumentos cargados:', instruments);
          console.log('üîç Primer instrumento (ejemplo):', instruments[0]);
        }

        if (!instruments || instruments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üéØ</div><div>No hay instrumentos registrados</div></div></td></tr>';
          return;
        }

        // Populate filter dropdowns with unique values (only if not skipping fetch)
        if (!skipFetch) {
          await populateInstrumentFilters(instruments);
        }

        // Apply filters
        const courseFilter = document.getElementById('instrumentCourseFilter').value;
        const situationFilter = document.getElementById('instrumentSituationFilter').value;
        const typeFilter = document.getElementById('instrumentTypeFilter').value;

        console.log('üîç Filtros activos:', { courseFilter, situationFilter, typeFilter });

        let filtered = instruments;

        if (courseFilter) {
          filtered = filtered.filter(inst => inst.Curso === courseFilter);
        }

        if (situationFilter) {
          filtered = filtered.filter(inst => inst.Situacion === situationFilter);
        }

        if (typeFilter) {
          filtered = filtered.filter(inst => inst.TipoInstrumento === typeFilter);
        }

        // Show filter info
        updateInstrumentFilterInfo(courseFilter, situationFilter, typeFilter, filtered.length, instruments.length);

        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">üîç</div><div>No se encontraron instrumentos con los filtros seleccionados</div></div></td></tr>';
          return;
        }

        tbody.innerHTML = filtered.map(inst => `
          <tr>
            <td>${inst.IDInstrumento || '-'}</td>
            <td>${inst.NombreInstrumento || '-'}</td>
            <td><span class="badge badge-warning">${inst.TipoInstrumento || '-'}</span></td>
            <td><span class="badge badge-primary">${inst.Curso || '-'}</span></td>
            <td>${inst.Situacion || '-'}</td>
            <td>
              <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;"
                      onclick="openInstrument('${inst.IDInstrumento}')">
                Abrir
              </button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        console.error('Error loading instruments:', err);
        tbody.innerHTML = '<tr><td colspan="6"><div class="alert alert-error">Error al cargar instrumentos</div></td></tr>';
      }
    }

    // Handle course filter change - updates situation dropdown dynamically
    async function onCourseFilterChange() {
      const courseFilter = document.getElementById('instrumentCourseFilter').value;

      // Ensure we have cached instruments data
      if (!cachedInstruments) {
        await loadInstruments();
        return;
      }

      console.log('üîÑ Curso seleccionado:', courseFilter);

      // Filter situations based on selected course
      let situationsToShow = cachedInstruments;

      if (courseFilter) {
        situationsToShow = cachedInstruments.filter(inst => inst.Curso === courseFilter);
        console.log(`üìã Situaciones del curso ${courseFilter}:`, situationsToShow.map(i => i.Situacion));
      } else {
        console.log('üìã Mostrando todas las situaciones');
      }

      // Extract unique situations from filtered instruments
      const situationsSet = new Set();
      situationsToShow.forEach(inst => {
        if (inst.Situacion) situationsSet.add(inst.Situacion);
      });

      // Update situation dropdown
      const situationSelect = document.getElementById('instrumentSituationFilter');
      const currentSituation = situationSelect.value;

      situationSelect.innerHTML = '<option value="">Todas las situaciones</option>' +
        Array.from(situationsSet).sort().map(s => `<option value="${s}">${s}</option>`).join('');

      // Try to preserve selection if it's still valid
      const validSituations = Array.from(situationsSet);
      if (validSituations.includes(currentSituation)) {
        situationSelect.value = currentSituation;
      } else {
        situationSelect.value = ''; // Reset if current selection is no longer valid
      }

      // Reload the table with updated filters
      loadInstruments(true); // true = skip fetch, use cache
    }

    // Populate instrument filter dropdowns
    async function populateInstrumentFilters(instruments) {
      // Extract unique courses from instruments (via their situations)
      const coursesSet = new Set();
      const situationsSet = new Set();

      instruments.forEach(inst => {
        if (inst.Curso) coursesSet.add(inst.Curso);
        if (inst.Situacion) situationsSet.add(inst.Situacion);
      });

      console.log('üìö Cursos encontrados:', Array.from(coursesSet));
      console.log('üìã Situaciones encontradas:', Array.from(situationsSet));

      // Populate course filter
      const courseSelect = document.getElementById('instrumentCourseFilter');
      const currentCourse = courseSelect.value;
      courseSelect.innerHTML = '<option value="">Todos los cursos</option>' +
        Array.from(coursesSet).sort().map(c => `<option value="${c}">${c}</option>`).join('');
      courseSelect.value = currentCourse;

      // Populate situation filter
      const situationSelect = document.getElementById('instrumentSituationFilter');
      const currentSituation = situationSelect.value;
      situationSelect.innerHTML = '<option value="">Todas las situaciones</option>' +
        Array.from(situationsSet).sort().map(s => `<option value="${s}">${s}</option>`).join('');
      situationSelect.value = currentSituation;
    }

    // Update filter info display
    function updateInstrumentFilterInfo(course, situation, type, filteredCount, totalCount) {
      const filterInfo = document.getElementById('instrumentsFilterInfo');
      const filterText = document.getElementById('instrumentsFilterText');

      const activeFilters = [];
      if (course) activeFilters.push(`Curso: ${course}`);
      if (situation) activeFilters.push(`Situaci√≥n: ${situation}`);
      if (type) activeFilters.push(`Tipo: ${type}`);

      if (activeFilters.length > 0) {
        filterInfo.style.display = 'block';
        filterText.textContent = `${activeFilters.join(' ‚Ä¢ ')} (${filteredCount} de ${totalCount} instrumentos)`;
      } else {
        filterInfo.style.display = 'none';
      }
    }

    // Clear all instrument filters
    function clearInstrumentFilters() {
      document.getElementById('instrumentCourseFilter').value = '';
      document.getElementById('instrumentSituationFilter').value = '';
      document.getElementById('instrumentTypeFilter').value = '';

      // Reset situation dropdown to show all situations
      if (cachedInstruments) {
        const situationsSet = new Set();
        cachedInstruments.forEach(inst => {
          if (inst.Situacion) situationsSet.add(inst.Situacion);
        });

        const situationSelect = document.getElementById('instrumentSituationFilter');
        situationSelect.innerHTML = '<option value="">Todas las situaciones</option>' +
          Array.from(situationsSet).sort().map(s => `<option value="${s}">${s}</option>`).join('');
      }

      loadInstruments(true); // Use cache
    }

    // ============================================================================
    // MODAL FUNCTIONS
    // ============================================================================

    function showModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      // Clear any error messages in modal
      const modal = document.getElementById(modalId);
      const errorMessages = modal.querySelectorAll('.alert-error');
      errorMessages.forEach(msg => msg.remove());
    }

    /**
     * Validate student ID input
     */
    function validateStudentId(studentId) {
      if (!studentId || studentId.trim() === '') {
        return { valid: false, error: 'Por favor ingresa un ID de estudiante' };
      }
      // Add more validation rules as needed
      return { valid: true };
    }

    /**
     * Validate course ID input
     */
    function validateCourseId(courseId) {
      if (!courseId || courseId.trim() === '') {
        return { valid: false, error: 'Por favor ingresa un ID de curso' };
      }
      // Add more validation rules as needed
      return { valid: true };
    }

    // ============================================================================
    // ATTENDANCE FUNCTIONS
    // ============================================================================

    function showAttendanceStudentModal() {
      document.getElementById('studentModalTitle').textContent = 'Reporte de Asistencia - Estudiante';
      document.getElementById('studentIdInput').value = '';

      document.getElementById('studentModalConfirm').onclick = async () => {
        const studentId = document.getElementById('studentIdInput').value.trim();
        const validation = validateStudentId(studentId);

        if (!validation.valid) {
          showError(validation.error);
          return;
        }

        closeModal('studentModal');
        showLoading('Generando reporte de asistencia...');

        try {
          const response = await callBackend('reportePorEstudiante', studentId);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Reporte de Asistencia - Estudiante ${studentId}`, response.data);
              showSuccess(response.message || 'Reporte generado exitosamente');
            } else {
              showSuccess(response.message || 'Reporte generado y guardado en hoja');
            }
          } else {
            showError(response?.message || 'Error al generar reporte');
          }
        } catch (err) {
          hideLoading();
          showError('Error al generar reporte', err.message);
        }
      };

      showModal('studentModal');
    }

    function showAttendanceCourseModal() {
      document.getElementById('courseModalTitle').textContent = 'Reporte de Asistencia - Curso';
      document.getElementById('courseIdInput').value = '';

      document.getElementById('courseModalConfirm').onclick = async () => {
        const courseId = document.getElementById('courseIdInput').value.trim();
        const validation = validateCourseId(courseId);

        if (!validation.valid) {
          showError(validation.error);
          return;
        }

        closeModal('courseModal');
        showLoading('Generando reporte de asistencia del curso...');

        try {
          const response = await callBackend('reportePorCurso', courseId);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Reporte de Asistencia - Curso ${courseId}`, response.data);
              showSuccess(response.message || 'Reporte generado exitosamente');
            } else {
              showSuccess(response.message || 'Reporte generado y guardado en hoja');
            }
          } else {
            showError(response?.message || 'Error al generar reporte');
          }
        } catch (err) {
          hideLoading();
          showError('Error al generar reporte', err.message);
        }
      };

      showModal('courseModal');
    }

    function compareStudents() {
      document.getElementById('comparisonModalTitle').textContent = 'Comparar Asistencia - Estudiantes';
      document.getElementById('comparisonLabel1').textContent = 'ID del primer estudiante';
      document.getElementById('comparisonLabel2').textContent = 'ID del segundo estudiante';
      document.getElementById('comparisonInput1').value = '';
      document.getElementById('comparisonInput2').value = '';

      document.getElementById('comparisonModalConfirm').onclick = async () => {
        const est1 = document.getElementById('comparisonInput1').value.trim();
        const est2 = document.getElementById('comparisonInput2').value.trim();

        if (!est1 || !est2) {
          showError('Por favor ingresa ambos IDs de estudiantes');
          return;
        }

        closeModal('comparisonModal');
        showLoading('Comparando estudiantes...');

        try {
          const response = await callBackend('compararEstudiantes', est1, est2);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Comparaci√≥n de Asistencia: ${est1} vs ${est2}`, response.data);
              showSuccess(response.message || 'Comparaci√≥n completada');
            } else {
              showSuccess(response.message || 'Comparaci√≥n completada y guardada en hoja');
            }
          } else {
            showError(response?.message || 'Error al comparar estudiantes');
          }
        } catch (err) {
          hideLoading();
          showError('Error al comparar estudiantes', err.message);
        }
      };

      showModal('comparisonModal');
    }

    function compareCourses() {
      document.getElementById('comparisonModalTitle').textContent = 'Comparar Asistencia - Cursos';
      document.getElementById('comparisonLabel1').textContent = 'ID del primer curso';
      document.getElementById('comparisonLabel2').textContent = 'ID del segundo curso';
      document.getElementById('comparisonInput1').value = '';
      document.getElementById('comparisonInput2').value = '';

      document.getElementById('comparisonModalConfirm').onclick = async () => {
        const cur1 = document.getElementById('comparisonInput1').value.trim();
        const cur2 = document.getElementById('comparisonInput2').value.trim();

        if (!cur1 || !cur2) {
          showError('Por favor ingresa ambos IDs de cursos');
          return;
        }

        closeModal('comparisonModal');
        showLoading('Comparando cursos...');

        try {
          const response = await callBackend('compararCursos', cur1, cur2);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Comparaci√≥n de Asistencia: ${cur1} vs ${cur2}`, response.data);
              showSuccess(response.message || 'Comparaci√≥n completada');
            } else {
              showSuccess(response.message || 'Comparaci√≥n completada y guardada en hoja');
            }
          } else {
            showError(response?.message || 'Error al comparar cursos');
          }
        } catch (err) {
          hideLoading();
          showError('Error al comparar cursos', err.message);
        }
      };

      showModal('comparisonModal');
    }

    async function openSchedulerDialog() {
      // ‚ö†Ô∏è Esta funci√≥n requiere UI de Google Sheets - solo funciona en Modal Mode
      if (!isModalMode) {
        showError(
          'Funci√≥n no disponible en Web App',
          'El programador de alertas requiere la interfaz de Google Sheets. Redirigiendo...'
        );
        setTimeout(() => {
          window.open('https://docs.google.com/spreadsheets/d/1WKVottJP88lQ-XxB2SLaLJc06aB5yQYw5peI-8WLaO0/', '_blank');
        }, 1500);
        return;
      }

      showLoading('Cargando programador de alertas...');
      try {
        const response = await callBackend('openSchedulerDialog');
        hideLoading();

        if (response && response.html) {
          // If response contains HTML, we need to handle it differently
          showError('Funcionalidad de programador pr√≥ximamente en el dashboard');
        } else {
          showSuccess(response?.message || 'Operaci√≥n completada');
        }
      } catch (err) {
        hideLoading();
        showError('Esta funci√≥n requiere abrir en ventana separada', err.message);
      }
    }

    async function openConfigDialog() {
      // ‚ö†Ô∏è Esta funci√≥n requiere UI de Google Sheets - solo funciona en Modal Mode
      if (!isModalMode) {
        showError(
          'Funci√≥n no disponible en Web App',
          'La configuraci√≥n de alertas requiere la interfaz de Google Sheets. Redirigiendo...'
        );
        setTimeout(() => {
          window.open('https://docs.google.com/spreadsheets/d/1WKVottJP88lQ-XxB2SLaLJc06aB5yQYw5peI-8WLaO0/', '_blank');
        }, 1500);
        return;
      }

      showLoading('Cargando configuraci√≥n...');
      try {
        const response = await callBackend('openConfigDialog');
        hideLoading();

        if (response && response.html) {
          showError('Funcionalidad de configuraci√≥n pr√≥ximamente en el dashboard');
        } else {
          showSuccess(response?.message || 'Operaci√≥n completada');
        }
      } catch (err) {
        hideLoading();
        showError('Esta funci√≥n requiere abrir en ventana separada', err.message);
      }
    }

    async function diagnosticarSistema() {
      // ‚ö†Ô∏è Esta funci√≥n requiere UI de Google Sheets - solo funciona en Modal Mode
      if (!isModalMode) {
        showError(
          'Funci√≥n no disponible en Web App',
          'El diagn√≥stico de sistema requiere la interfaz de Google Sheets. Redirigiendo...'
        );
        setTimeout(() => {
          window.open('https://docs.google.com/spreadsheets/d/1WKVottJP88lQ-XxB2SLaLJc06aB5yQYw5peI-8WLaO0/', '_blank');
        }, 1500);
        return;
      }

      showLoading('Ejecutando diagn√≥stico del sistema...');
      try {
        const response = await callBackend('diagnosticarSistemaAlertas');
        hideLoading();

        if (response && response.success) {
          showSuccess(response.message || 'Diagn√≥stico completado');
        } else if (response && response.message) {
          showSuccess(response.message);
        } else {
          showError('No se pudo completar el diagn√≥stico');
        }
      } catch (err) {
        hideLoading();
        showError('Error al diagnosticar el sistema', err.message);
      }
    }

    // ============================================================================
    // ATTENDANCE REGISTRATION FUNCTIONS
    // ============================================================================

    let attendanceStudentsCache = [];

    /**
     * Load courses and schools for attendance registration
     */
    async function loadAttendanceDropdowns() {
      try {
        // Load courses
        const courses = await callBackend('getCourses');
        const courseSelect = document.getElementById('attendanceCourseSelect');
        courseSelect.innerHTML = '<option value="">Selecciona un curso...</option>' +
          courses.map(c => `<option value="${c}">${c}</option>`).join('');

        // Load schools
        const schools = await callBackend('getSchools');
        const schoolSelect = document.getElementById('attendanceSchoolSelect');
        schoolSelect.innerHTML = '<option value="">Selecciona un colegio...</option>' +
          schools.map(s => `<option value="${s}">${s}</option>`).join('');
      } catch (err) {
        console.error('Error loading attendance dropdowns:', err);
        showError('Error al cargar cursos y colegios', err.message);
      }
    }

    /**
     * Load students for selected course
     */
    async function loadStudentsForAttendance() {
      const courseId = document.getElementById('attendanceCourseSelect').value;
      const studentsListDiv = document.getElementById('attendanceStudentsList');
      const tbody = document.getElementById('attendanceStudentsTable');

      if (!courseId) {
        studentsListDiv.style.display = 'none';
        return;
      }

      try {
        showLoading('Cargando estudiantes...');

        const allStudents = await callBackend('getEstudiantesData');
        attendanceStudentsCache = allStudents.filter(s => s.CursoID === courseId);

        hideLoading();

        if (attendanceStudentsCache.length === 0) {
          showError('No hay estudiantes en este curso');
          studentsListDiv.style.display = 'none';
          return;
        }

        // Build table rows
        tbody.innerHTML = attendanceStudentsCache.map((student, index) => `
          <tr class="student-row" id="student-row-${index}">
            <td>
              <div style="line-height: 1.4;">
                <strong style="font-size: 0.9375rem; color: var(--text);">${student.NombreEstudiante || 'Sin nombre'}</strong><br>
                <span style="font-size: 0.8125rem; color: var(--text-light);">ID: ${student.IDEstudiante}</span>
              </div>
            </td>
            <td>
              <input type="checkbox" id="presente-${index}" onchange="updateRowHighlight(${index})">
            </td>
            <td>
              <input type="checkbox" id="retraso-${index}">
            </td>
            <td>
              <input type="checkbox" id="sinUniforme-${index}">
            </td>
            <td>
              <input type="checkbox" id="sinAseo-${index}">
            </td>
          </tr>
        `).join('');

        studentsListDiv.style.display = 'block';
      } catch (err) {
        hideLoading();
        console.error('Error loading students:', err);
        showError('Error al cargar estudiantes', err.message);
      }
    }

    /**
     * Update row highlight when present checkbox changes
     */
    function updateRowHighlight(index) {
      const row = document.getElementById(`student-row-${index}`);
      const presentCheckbox = document.getElementById(`presente-${index}`);

      if (presentCheckbox.checked) {
        row.classList.add('present');
      } else {
        row.classList.remove('present');
      }
    }

    /**
     * Mark all students as present
     */
    function markAllPresent() {
      attendanceStudentsCache.forEach((_, index) => {
        const presentCheckbox = document.getElementById(`presente-${index}`);
        if (presentCheckbox) {
          presentCheckbox.checked = true;
          updateRowHighlight(index);
        }
      });
      showSuccess('Todos los estudiantes marcados como presentes');
    }

    /**
     * Clear all attendance checkboxes
     */
    function clearAllAttendance() {
      attendanceStudentsCache.forEach((_, index) => {
        ['presente', 'retraso', 'sinUniforme', 'sinAseo'].forEach(field => {
          const checkbox = document.getElementById(`${field}-${index}`);
          if (checkbox) {
            checkbox.checked = false;
          }
        });
        updateRowHighlight(index);
      });
      showSuccess('Todos los registros limpiados');
    }

    /**
     * Save attendance batch
     */
    async function saveAttendanceBatch() {
      const fecha = document.getElementById('attendanceDate').value;
      const cursoId = document.getElementById('attendanceCourseSelect').value;
      const colegioId = document.getElementById('attendanceSchoolSelect').value;

      // Validation
      if (!fecha) {
        showError('Por favor selecciona una fecha');
        return;
      }
      if (!cursoId) {
        showError('Por favor selecciona un curso');
        return;
      }
      if (!colegioId) {
        showError('Por favor selecciona un colegio');
        return;
      }

      // Collect attendance records
      const records = [];
      attendanceStudentsCache.forEach((student, index) => {
        const presente = document.getElementById(`presente-${index}`).checked;
        const retraso = document.getElementById(`retraso-${index}`).checked;
        const sinUniforme = document.getElementById(`sinUniforme-${index}`).checked;
        const sinAseo = document.getElementById(`sinAseo-${index}`).checked;

        records.push({
          IDEstudiante: student.IDEstudiante,
          NombreEstudiante: student.NombreEstudiante,
          CursoID: cursoId,
          ColegioID: colegioId,
          Fecha: fecha,
          Presente: presente,
          Retraso: retraso,
          SinUniforme: sinUniforme,
          SinAseo: sinAseo
        });
      });

      try {
        showLoading(`Guardando asistencia de ${records.length} estudiantes...`);

        const response = await callBackend('registrarAsistenciaBatch', records);
        hideLoading();

        if (response && response.success) {
          showSuccess(response.message || `Asistencia guardada exitosamente para ${records.length} estudiantes`);
          cancelAttendanceRegistration();
          loadRecentAttendance();
        } else {
          showError(response?.message || 'Error al guardar asistencia');
        }
      } catch (err) {
        hideLoading();
        showError('Error al guardar asistencia', err.message);
      }
    }

    /**
     * Cancel attendance registration
     */
    function cancelAttendanceRegistration() {
      document.getElementById('attendanceCourseSelect').value = '';
      document.getElementById('attendanceSchoolSelect').value = '';
      document.getElementById('attendanceStudentsList').style.display = 'none';
      document.getElementById('attendanceStudentsTable').innerHTML = '';
      attendanceStudentsCache = [];
    }

    /**
     * Load recent attendance records
     */
    async function loadRecentAttendance() {
      try {
        const records = await callBackend('getRecentAttendance', 10);

        if (!records || records.length === 0) {
          document.getElementById('recentAttendanceCard').style.display = 'none';
          return;
        }

        const tbody = document.getElementById('recentAttendanceTable');
        tbody.innerHTML = records.map(record => {
          const observations = [];
          if (record.Retraso) observations.push('Retraso');
          if (record.SinUniforme) observations.push('Sin uniforme');
          if (record.SinAseo) observations.push('Sin aseo');

          return `
            <tr>
              <td>${record.Fecha || '-'}</td>
              <td>${record.NombreEstudiante || '-'}</td>
              <td><span class="badge badge-primary">${record.CursoID || '-'}</span></td>
              <td>
                <span class="badge ${record.Presente ? 'badge-success' : 'badge-danger'}">
                  ${record.Presente ? '‚úì Presente' : '‚úó Ausente'}
                </span>
              </td>
              <td>${observations.join(', ') || '-'}</td>
            </tr>
          `;
        }).join('');

        document.getElementById('recentAttendanceCard').style.display = 'block';
      } catch (err) {
        console.error('Error loading recent attendance:', err);
      }
    }

    // ============================================================================
    // GRADES FUNCTIONS
    // ============================================================================

    function showGradesStudentModal() {
      document.getElementById('studentModalTitle').textContent = 'Calificaciones - Estudiante';
      document.getElementById('studentIdInput').value = '';

      document.getElementById('studentModalConfirm').onclick = async () => {
        const studentId = document.getElementById('studentIdInput').value.trim();
        const validation = validateStudentId(studentId);

        if (!validation.valid) {
          showError(validation.error);
          return;
        }

        closeModal('studentModal');
        showLoading('Consultando calificaciones...');

        try {
          const response = await callBackend('reporteCalificacionPorEstudiante', studentId);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Reporte de Calificaciones - Estudiante ${studentId}`, response.data);
              showSuccess(response.message || 'Reporte generado exitosamente');
            } else {
              showSuccess(response.message || 'Reporte generado y guardado en hoja');
            }
            loadStats();
          } else {
            showError(response?.message || 'Error al generar reporte');
          }
        } catch (err) {
          hideLoading();
          showError('Error al generar reporte', err.message);
        }
      };

      showModal('studentModal');
    }

    function showGradesCourseModal() {
      document.getElementById('courseModalTitle').textContent = 'Calificaciones - Curso';
      document.getElementById('courseIdInput').value = '';

      document.getElementById('courseModalConfirm').onclick = async () => {
        const courseId = document.getElementById('courseIdInput').value.trim();
        const validation = validateCourseId(courseId);

        if (!validation.valid) {
          showError(validation.error);
          return;
        }

        closeModal('courseModal');
        showLoading('Consultando calificaciones del curso...');

        try {
          const response = await callBackend('reporteCalificacionPorCurso', courseId);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Reporte de Calificaciones - Curso ${courseId}`, response.data);
              showSuccess(response.message || 'Reporte generado exitosamente');
            } else {
              showSuccess(response.message || 'Reporte generado y guardado en hoja');
            }
            loadStats();
          } else {
            showError(response?.message || 'Error al generar reporte');
          }
        } catch (err) {
          hideLoading();
          showError('Error al generar reporte', err.message);
        }
      };

      showModal('courseModal');
    }

    function compareGradesStudents() {
      document.getElementById('comparisonModalTitle').textContent = 'Comparar Calificaciones - Estudiantes';
      document.getElementById('comparisonLabel1').textContent = 'ID del primer estudiante';
      document.getElementById('comparisonLabel2').textContent = 'ID del segundo estudiante';
      document.getElementById('comparisonInput1').value = '';
      document.getElementById('comparisonInput2').value = '';

      document.getElementById('comparisonModalConfirm').onclick = async () => {
        const est1 = document.getElementById('comparisonInput1').value.trim();
        const est2 = document.getElementById('comparisonInput2').value.trim();

        if (!est1 || !est2) {
          showError('Por favor ingresa ambos IDs de estudiantes');
          return;
        }

        closeModal('comparisonModal');
        showLoading('Comparando calificaciones...');

        try {
          const response = await callBackend('compararCalificacionesEstudiantes', est1, est2);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Comparaci√≥n de Calificaciones: ${est1} vs ${est2}`, response.data);
              showSuccess(response.message || 'Comparaci√≥n completada');
            } else {
              showSuccess(response.message || 'Comparaci√≥n completada y guardada en hoja');
            }
          } else {
            showError(response?.message || 'Error al comparar calificaciones');
          }
        } catch (err) {
          hideLoading();
          showError('Error al comparar calificaciones', err.message);
        }
      };

      showModal('comparisonModal');
    }

    function compareGradesCourses() {
      document.getElementById('comparisonModalTitle').textContent = 'Comparar Calificaciones - Cursos';
      document.getElementById('comparisonLabel1').textContent = 'ID del primer curso';
      document.getElementById('comparisonLabel2').textContent = 'ID del segundo curso';
      document.getElementById('comparisonInput1').value = '';
      document.getElementById('comparisonInput2').value = '';

      document.getElementById('comparisonModalConfirm').onclick = async () => {
        const cur1 = document.getElementById('comparisonInput1').value.trim();
        const cur2 = document.getElementById('comparisonInput2').value.trim();

        if (!cur1 || !cur2) {
          showError('Por favor ingresa ambos IDs de cursos');
          return;
        }

        closeModal('comparisonModal');
        showLoading('Comparando calificaciones...');

        try {
          const response = await callBackend('compararCalificacionesCursos', cur1, cur2);
          hideLoading();

          if (response && response.success) {
            if (response.data) {
              showReportResults(`Comparaci√≥n de Calificaciones: ${cur1} vs ${cur2}`, response.data);
              showSuccess(response.message || 'Comparaci√≥n completada');
            } else {
              showSuccess(response.message || 'Comparaci√≥n completada y guardada en hoja');
            }
          } else {
            showError(response?.message || 'Error al comparar calificaciones');
          }
        } catch (err) {
          hideLoading();
          showError('Error al comparar calificaciones', err.message);
        }
      };

      showModal('comparisonModal');
    }

    // ============================================================================
    // INSTRUMENTS FUNCTIONS
    // ============================================================================

    async function openInstrument(instrumentId) {
      try {
        showLoading('Abriendo instrumento...');
        const url = await callBackend('getWebAppUrl');
        hideLoading();

        const finalUrl = url + '?instrumentId=' + encodeURIComponent(instrumentId);
        window.open(finalUrl, '_blank');
      } catch (err) {
        hideLoading();
        console.error('Error getting URL:', err);
        showError('Error al abrir el instrumento', err.message);
      }
    }

    // ============================================================================
    // REPORTS FUNCTIONS
    // ============================================================================

    async function generateSituationReport() {
      showLoading('Obteniendo cursos y situaciones...');

      try {
        // Obtener el mapping de cursos y situaciones
        const mappingResponse = await callBackend('getCursosSituacionesMapping');
        hideLoading();

        if (!mappingResponse || !mappingResponse.success) {
          showError('Error', mappingResponse?.message || 'No se pudo obtener la lista de cursos y situaciones');
          return;
        }

        const mapping = mappingResponse.data;
        const cursos = Object.keys(mapping).sort();

        if (cursos.length === 0) {
          showError('Sin datos', 'No hay cursos con situaciones disponibles');
          return;
        }

        // Crear di√°logo para seleccionar curso y situaci√≥n
        const dialog = document.createElement('div');
        dialog.className = 'modal';
        dialog.innerHTML = `
          <div class="modal-content" style="max-width: 500px;">
            <h3>Generar Reporte de Notas por Situaci√≥n</h3>
            <div class="form-group">
              <label for="select-curso">Curso:</label>
              <select id="select-curso" class="form-control">
                ${cursos.map(c => `<option value="${c}">${c}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label for="select-situacion">Situaci√≥n:</label>
              <select id="select-situacion" class="form-control">
              </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" id="btn-generar-notas">Generar Reporte</button>
              <button class="btn btn-outline" id="btn-cancelar-notas">Cancelar</button>
            </div>
          </div>
        `;
        document.body.appendChild(dialog);
        dialog.classList.add('active');

        const cursoSelect = document.getElementById('select-curso');
        const situacionSelect = document.getElementById('select-situacion');

        // Funci√≥n para actualizar situaciones basado en curso seleccionado
        function updateSituaciones() {
          const selectedCurso = cursoSelect.value;
          const situaciones = mapping[selectedCurso] || [];
          situacionSelect.innerHTML = situaciones.map(s =>
            `<option value="${s}">${s}</option>`
          ).join('');
        }

        cursoSelect.addEventListener('change', updateSituaciones);
        updateSituaciones();

        // Manejar generaci√≥n
        document.getElementById('btn-generar-notas').addEventListener('click', async () => {
          const curso = cursoSelect.value;
          const situacion = situacionSelect.value;

          dialog.remove();
          showLoading('Generando reporte...');

          try {
            const response = await callBackend('generateReporteNotasSituacion', curso, situacion);
            hideLoading();

            if (response && response.success) {
              showSuccess(response.message);

              // Mostrar los datos del reporte en el modal
              if (response.data && response.data.length > 0) {
                showReportResults(
                  `Reporte de Notas: ${curso} - ${situacion}`,
                  response.data
                );
              }
            } else {
              showError('Error', response?.message || 'No se pudo generar el reporte');
            }
          } catch (err) {
            hideLoading();
            showError('Error al generar reporte', err.message);
          }
        });

        document.getElementById('btn-cancelar-notas').addEventListener('click', () => {
          dialog.remove();
        });

      } catch (err) {
        hideLoading();
        showError('Error', err.message);
      }
    }

    async function generateAdvancedAttendanceReport() {
      showLoading('Generando reporte avanzado de asistencia...');

      try {
        const response = await callBackend('reporteAsistenciaAvanzada_UI');
        hideLoading();

        if (response && response.success) {
          showSuccess(response.message || 'Reporte generado exitosamente');

          // Mostrar estad√≠sticas si est√°n disponibles
          if (response.data) {
            const { global, cursos, estudiantes } = response.data;

            // Crear estructura de datos para visualizar
            const reportData = {
              'Estad√≠sticas Globales': {
                'Total de registros': global.totalRegistros,
                'Total presentes': global.totalPresentes,
                'Total ausentes': global.totalAusentes,
                'Porcentaje de asistencia': global.porcentajeGlobal + '%'
              },
              'Por Curso': cursos,
              'Por Estudiante': estudiantes.slice(0, 20) // Mostrar los primeros 20 estudiantes
            };

            // Crear HTML personalizado para mostrar las tres secciones
            const body = document.getElementById('reportResultsBody');
            body.innerHTML = `
              <div style="margin-bottom: 20px;">
                <h4 style="color: #2563eb; margin-bottom: 10px;">üìä Estad√≠sticas Globales</h4>
                <div class="table-container">
                  <table>
                    <tbody>
                      <tr><th style="width: 50%; text-align: left;">Total de registros</th><td>${global.totalRegistros}</td></tr>
                      <tr><th style="width: 50%; text-align: left;">Total presentes</th><td>${global.totalPresentes}</td></tr>
                      <tr><th style="width: 50%; text-align: left;">Total ausentes</th><td>${global.totalAusentes}</td></tr>
                      <tr><th style="width: 50%; text-align: left;">Porcentaje de asistencia</th><td><strong>${global.porcentajeGlobal}%</strong></td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div style="margin-bottom: 20px;">
                <h4 style="color: #2563eb; margin-bottom: 10px;">üìö Por Curso</h4>
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Curso</th>
                        <th>Total</th>
                        <th>Presentes</th>
                        <th>Ausentes</th>
                        <th>% Asistencia</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${cursos.map(c => `
                        <tr>
                          <td>${c.curso}</td>
                          <td>${c.total}</td>
                          <td>${c.presentes}</td>
                          <td>${c.ausentes}</td>
                          <td><strong>${c.porcentaje}%</strong></td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>

              <div>
                <h4 style="color: #2563eb; margin-bottom: 10px;">üë§ Por Estudiante (Primeros 20)</h4>
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>Estudiante</th>
                        <th>Total</th>
                        <th>Presentes</th>
                        <th>Ausentes</th>
                        <th>% Asistencia</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${estudiantes.slice(0, 20).map(e => `
                        <tr>
                          <td>${e.estudiante}</td>
                          <td>${e.total}</td>
                          <td>${e.presentes}</td>
                          <td>${e.ausentes}</td>
                          <td><strong>${e.porcentaje}%</strong></td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
                ${estudiantes.length > 20 ? `<p style="margin-top: 10px; color: #64748b;"><em>Mostrando 20 de ${estudiantes.length} estudiantes. Ver hoja completa en el spreadsheet.</em></p>` : ''}
              </div>
            `;

            document.getElementById('reportResultsTitle').textContent = 'Reporte Avanzado de Asistencia';
            showModal('reportResultsModal');
          }
        } else {
          showError('Error', response?.message || 'No se pudo generar el reporte');
        }
      } catch (err) {
        hideLoading();
        showError('Error al generar reporte', err.message);
      }
    }

    async function viewExistingReports() {
      console.log('=== viewExistingReports iniciado ===');
      showLoading('Obteniendo lista de reportes...');

      let reportes = [];
      let errorMessage = null;

      try {
        console.log('üîÑ Llamando a listarReportesExistentes...');
        console.log('Modo:', isModalMode ? 'Modal' : 'Web App');
        const response = await callBackend('listarReportesExistentes');
        console.log('‚úÖ Respuesta RAW completa:', response);
        console.log('Tipo:', typeof response);
        console.log('Keys:', response ? Object.keys(response) : 'null');
        hideLoading();

        // Debug exhaustivo de la estructura
        if (response) {
          console.log('üìä response.success:', response.success);
          console.log('üìä response.result:', response.result);
          console.log('üìä response.data:', response.data);
          console.log('üìä response.result?.success:', response.result?.success);
          console.log('üìä response.result?.data:', response.result?.data);
        }

        // Extraer datos de la respuesta con manejo robusto
        let actualData = null;
        let arrayReportes = null;

        // Estrategia 1: Web App mode - response.result contiene el resultado
        if (response && response.success && response.result) {
          console.log('‚úÖ Estrategia 1: Web App mode (response.result)');
          actualData = response.result;
        }
        // Estrategia 2: Modal mode - response es directamente el resultado
        else if (response && response.success !== undefined) {
          console.log('‚úÖ Estrategia 2: Modal mode (response directo)');
          actualData = response;
        }
        // Estrategia 3: Response es el resultado sin envolver
        else {
          console.log('‚ö†Ô∏è Estrategia 3: Response sin estructura conocida');
          actualData = response;
        }

        console.log('üîç actualData:', actualData);
        console.log('üîç actualData.success:', actualData?.success);
        console.log('üîç actualData.data:', actualData?.data);
        console.log('üîç actualData.data es array:', Array.isArray(actualData?.data));

        // Verificar si tenemos un array v√°lido de reportes
        if (actualData) {
          // Caso 1: success=true y data es array
          if (actualData.success === true && Array.isArray(actualData.data)) {
            arrayReportes = actualData.data;
            console.log(`‚úÖ Caso 1: Array de reportes en actualData.data (${arrayReportes.length} items)`);
          }
          // Caso 2: success=false (error del backend)
          else if (actualData.success === false) {
            errorMessage = actualData.message || 'Error del servidor';
            console.error('‚ùå Caso 2: Backend retorn√≥ error:', errorMessage);
          }
          // Caso 3: data existe pero no es array
          else if (actualData.data !== undefined && !Array.isArray(actualData.data)) {
            errorMessage = 'La respuesta contiene data pero no es un array';
            console.error('‚ùå Caso 3:', errorMessage, 'data:', actualData.data);
          }
          // Caso 4: estructura inesperada
          else {
            errorMessage = actualData.message || 'Estructura de respuesta no reconocida';
            console.error('‚ùå Caso 4: Estructura inesperada');
            console.error('actualData completo:', JSON.stringify(actualData, null, 2));
          }
        } else {
          errorMessage = 'Respuesta vac√≠a del servidor';
          console.error('‚ùå actualData es null/undefined');
        }

        // Asignar reportes si se encontraron
        if (arrayReportes && arrayReportes.length > 0) {
          reportes = arrayReportes;
          console.log(`‚úÖ √âXITO: ${reportes.length} reportes encontrados`);
          console.log('üìã Primer reporte:', reportes[0]);
        } else if (arrayReportes) {
          console.log('‚ö†Ô∏è Array de reportes vac√≠o (sin errores)');
        }
      } catch (error) {
        hideLoading();
        errorMessage = 'Error de conexi√≥n: ' + error.message;
        console.error('‚ùå EXCEPCI√ìN:', error);
        console.error('Stack:', error.stack);
      }

      console.log(`Renderizando lista con ${reportes.length} reportes en el Dashboard...`);

      // Agrupar reportes por tipo
      const reportesPorTipo = {
        notas: reportes.filter(r => r.tipo === 'notas'),
        calificaciones: reportes.filter(r => r.tipo === 'calificaciones'),
        asistencia: reportes.filter(r => r.tipo === 'asistencia'),
        comparativa: reportes.filter(r => r.tipo === 'comparativa'),
        diagnostico: reportes.filter(r => r.tipo === 'diagnostico'),
        general: reportes.filter(r => r.tipo === 'general')
      };

      const formatFecha = (fecha) => {
        try {
          return new Date(fecha).toLocaleString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } catch {
          return 'Fecha desconocida';
        }
      };

      // Obtener badge color seg√∫n el subtipo
      const getBadgeStyle = (subtipo) => {
        const styles = {
          situacion: 'background: rgba(37, 99, 235, 0.1); color: #2563eb;',
          estudiante: 'background: rgba(16, 185, 129, 0.1); color: #10b981;',
          curso: 'background: rgba(245, 158, 11, 0.1); color: #f59e0b;',
          avanzado: 'background: rgba(139, 92, 246, 0.1); color: #8b5cf6;',
          simple: 'background: rgba(100, 116, 139, 0.1); color: #64748b;',
          fecha: 'background: rgba(236, 72, 153, 0.1); color: #ec4899;',
          estudiantes: 'background: rgba(14, 165, 233, 0.1); color: #0ea5e9;',
          cursos: 'background: rgba(251, 146, 60, 0.1); color: #fb923c;',
          sistema: 'background: rgba(239, 68, 68, 0.1); color: #ef4444;'
        };
        return styles[subtipo] || 'background: rgba(100, 116, 139, 0.1); color: #64748b;';
      };

      const crearListaReportes = (listaReportes, titulo, icono, color = '#2563eb') => {
        if (listaReportes.length === 0) return '';
        return `
          <div style="margin-bottom: 24px;">
            <h4 style="color: ${color}; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 1.3em;">${icono}</span>
              <span>${titulo}</span>
              <span style="background: ${color}15; color: ${color}; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">${listaReportes.length}</span>
            </h4>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${listaReportes.map(r => `
                <button
                  class="btn btn-outline"
                  style="text-align: left; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;"
                  onclick="loadReportInDashboard('${r.nombre}')"
                  onmouseover="this.style.transform='translateX(4px)'; this.style.borderColor='${color}'; this.style.backgroundColor='${color}05';"
                  onmouseout="this.style.transform='translateX(0)'; this.style.borderColor='#e2e8f0'; this.style.backgroundColor='transparent';"
                >
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                      <span style="font-weight: 600; color: #1e293b;">${r.nombre}</span>
                      ${r.subtipo ? `<span style="padding: 2px 8px; border-radius: 999px; font-size: 0.7em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; ${getBadgeStyle(r.subtipo)}">${r.subtipo.replace(/_/g, ' ')}</span>` : ''}
                    </div>
                    <div style="font-size: 0.85em; color: #64748b;">
                      ${r.info.curso && r.info.situacion ?
            `<strong>Curso:</strong> ${r.info.curso} | <strong>Situaci√≥n:</strong> ${r.info.situacion}` :
            r.info.descripcion || r.info.fecha || ''}
                    </div>
                  </div>
                  <div style="font-size: 0.75em; color: #94a3b8; text-align: right; margin-left: 12px;">
                    <div>${formatFecha(r.ultimaModificacion)}</div>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>
        `;
      };

      // Contar total de reportes
      const totalReportes = reportes.length;

      // Mostrar mensaje de error si existe
      const mensajeError = errorMessage ? `
        <div class="alert alert-error" style="margin-bottom: 20px;">
          <span style="font-size: 1.2em;">‚ö†Ô∏è</span>
          <div>
            <strong>Error al cargar reportes</strong>
            <p style="margin: 4px 0 0 0; font-size: 0.9em;">${errorMessage}</p>
          </div>
        </div>
      ` : '';

      const contenidoReportes = totalReportes > 0 ? `
          ${crearListaReportes(reportesPorTipo.notas, 'Reportes de Notas por Situaci√≥n', 'üìù', '#2563eb')}
          ${crearListaReportes(reportesPorTipo.calificaciones, 'Reportes de Calificaciones', 'üìä', '#8b5cf6')}
          ${crearListaReportes(reportesPorTipo.asistencia, 'Reportes de Asistencia', 'üìã', '#10b981')}
          ${crearListaReportes(reportesPorTipo.comparativa, 'An√°lisis Comparativos', 'üìà', '#f59e0b')}
          ${crearListaReportes(reportesPorTipo.diagnostico, 'Diagn√≥sticos del Sistema', 'üîß', '#ef4444')}
          ${crearListaReportes(reportesPorTipo.general, 'Otros Reportes', 'üìÑ', '#64748b')}
        ` : `
          <div style="text-align: center; padding: 40px 20px; background: #f8fafc; border-radius: 12px; border: 2px dashed #e2e8f0;">
            <div style="font-size: 3em; margin-bottom: 16px; opacity: 0.5;">üìä</div>
            <h4 style="color: #64748b; margin-bottom: 8px; font-weight: 600;">No hay reportes disponibles</h4>
            <p style="color: #94a3b8; font-size: 0.9em;">Genera reportes desde las opciones del men√∫ para visualizarlos aqu√≠</p>
          </div>
        `;

      // Renderizar en el Dashboard
      const container = document.getElementById('reportes-existentes-container');
      const listaDashboard = document.getElementById('reportes-lista-dashboard');
      const badge = document.getElementById('reportes-badge');
      const searchContainer = document.getElementById('reportes-search-container');

      // Actualizar badge
      badge.textContent = `${totalReportes} ${totalReportes === 1 ? 'reporte' : 'reportes'}`;

      // Insertar contenido
      listaDashboard.innerHTML = mensajeError + contenidoReportes;

      // Mostrar/ocultar b√∫squeda seg√∫n si hay reportes
      if (totalReportes > 0) {
        searchContainer.style.display = 'block';
      } else {
        searchContainer.style.display = 'none';
      }

      // Mostrar el contenedor
      container.style.display = 'block';

      // Scroll suave hacia la lista
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Funcionalidad de b√∫squeda
      if (totalReportes > 0) {
        const searchInput = document.getElementById('search-reportes-dashboard');

        // Limpiar event listeners previos
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);

        newSearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase().trim();

          if (searchTerm === '') {
            // Mostrar todos los reportes
            listaDashboard.innerHTML = mensajeError + contenidoReportes;
            badge.textContent = `${totalReportes} ${totalReportes === 1 ? 'reporte' : 'reportes'}`;
            return;
          }

          // Filtrar reportes
          const reportesFiltrados = {
            notas: reportesPorTipo.notas.filter(r =>
              r.nombre.toLowerCase().includes(searchTerm) ||
              (r.info.descripcion && r.info.descripcion.toLowerCase().includes(searchTerm)) ||
              (r.info.curso && r.info.curso.toLowerCase().includes(searchTerm)) ||
              (r.info.situacion && r.info.situacion.toLowerCase().includes(searchTerm))
            ),
            calificaciones: reportesPorTipo.calificaciones.filter(r =>
              r.nombre.toLowerCase().includes(searchTerm) ||
              (r.info.descripcion && r.info.descripcion.toLowerCase().includes(searchTerm))
            ),
            asistencia: reportesPorTipo.asistencia.filter(r =>
              r.nombre.toLowerCase().includes(searchTerm) ||
              (r.info.descripcion && r.info.descripcion.toLowerCase().includes(searchTerm)) ||
              (r.info.fecha && r.info.fecha.toLowerCase().includes(searchTerm))
            ),
            comparativa: reportesPorTipo.comparativa.filter(r =>
              r.nombre.toLowerCase().includes(searchTerm) ||
              (r.info.descripcion && r.info.descripcion.toLowerCase().includes(searchTerm))
            ),
            diagnostico: reportesPorTipo.diagnostico.filter(r =>
              r.nombre.toLowerCase().includes(searchTerm) ||
              (r.info.descripcion && r.info.descripcion.toLowerCase().includes(searchTerm))
            ),
            general: reportesPorTipo.general.filter(r =>
              r.nombre.toLowerCase().includes(searchTerm) ||
              (r.info.descripcion && r.info.descripcion.toLowerCase().includes(searchTerm))
            )
          };

          const totalFiltrados = Object.values(reportesFiltrados).reduce((sum, arr) => sum + arr.length, 0);
          badge.textContent = `${totalFiltrados} ${totalFiltrados === 1 ? 'reporte' : 'reportes'}`;

          if (totalFiltrados === 0) {
            listaDashboard.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; background: #f8fafc; border-radius: 12px; border: 2px dashed #e2e8f0;">
                <div style="font-size: 3em; margin-bottom: 16px; opacity: 0.5;">üîç</div>
                <h4 style="color: #64748b; margin-bottom: 8px; font-weight: 600;">No se encontraron reportes</h4>
                <p style="color: #94a3b8; font-size: 0.9em;">Intenta con otro t√©rmino de b√∫squeda</p>
              </div>
            `;
          } else {
            listaDashboard.innerHTML = `
              ${crearListaReportes(reportesFiltrados.notas, 'Reportes de Notas por Situaci√≥n', 'üìù', '#2563eb')}
              ${crearListaReportes(reportesFiltrados.calificaciones, 'Reportes de Calificaciones', 'üìä', '#8b5cf6')}
              ${crearListaReportes(reportesFiltrados.asistencia, 'Reportes de Asistencia', 'üìã', '#10b981')}
              ${crearListaReportes(reportesFiltrados.comparativa, 'An√°lisis Comparativos', 'üìà', '#f59e0b')}
              ${crearListaReportes(reportesFiltrados.diagnostico, 'Diagn√≥sticos del Sistema', 'üîß', '#ef4444')}
              ${crearListaReportes(reportesFiltrados.general, 'Otros Reportes', 'üìÑ', '#64748b')}
            `;
          }
        });
      }
    }

    // Funci√≥n para ocultar la lista de reportes
    function ocultarListaReportes() {
      const container = document.getElementById('reportes-existentes-container');
      container.style.display = 'none';

      // Limpiar b√∫squeda
      const searchInput = document.getElementById('search-reportes-dashboard');
      if (searchInput) {
        searchInput.value = '';
      }
    }

    // Funci√≥n global para cargar reporte desde el Dashboard
    window.loadReportInDashboard = async (nombreHoja) => {
      showLoading('Cargando reporte...');

      try {
        const response = await callBackend('leerReporteExistente', nombreHoja);
        console.log('üîç [loadReportInDashboard] Respuesta RAW:', response);
        console.log('üîç [loadReportInDashboard] Tipo:', typeof response);
        console.log('üîç [loadReportInDashboard] Keys:', response ? Object.keys(response) : 'null');
        hideLoading();

        // Aplicar el mismo unwrapping que en viewExistingReports
        let actualData = null;

        // Web App mode: response.result contiene el resultado
        if (response && response.success && response.result) {
          console.log('‚úÖ Modo Web App detectado (response.result)');
          actualData = response.result;
        }
        // Modal mode: response es directamente el resultado
        else if (response && response.success !== undefined) {
          console.log('‚úÖ Modo Modal detectado (response directo)');
          actualData = response;
        }
        // Fallback
        else {
          console.log('‚ö†Ô∏è Modo desconocido, usando response directo');
          actualData = response;
        }

        console.log('üìä [loadReportInDashboard] Datos despu√©s de unwrap:', actualData);
        console.log('üìä [loadReportInDashboard] actualData.success:', actualData?.success);
        console.log('üìä [loadReportInDashboard] actualData.data:', actualData?.data);
        console.log('üìä [loadReportInDashboard] actualData.headers:', actualData?.headers);

        if (actualData && actualData.success) {
          // Mostrar el reporte con su t√≠tulo personalizado
          console.log('‚úÖ Llamando a showReportInModal');
          showReportInModal(nombreHoja, actualData);
        } else {
          const errorMsg = actualData?.message || 'No se pudo cargar el reporte';
          console.error('‚ùå Error:', errorMsg);
          showError('Error', errorMsg);
        }
      } catch (err) {
        hideLoading();
        console.error('‚ùå Excepci√≥n en loadReportInDashboard:', err);
        showError('Error al cargar reporte', err.message);
      }
    }

    /**
     * Muestra un reporte completo en el modal con formato mejorado
     */
    function showReportInModal(nombreHoja, reportData) {
      console.log('üìã [showReportInModal] nombreHoja:', nombreHoja);
      console.log('üìã [showReportInModal] reportData:', reportData);

      const { data, headers, sheetName } = reportData;

      console.log('üìã [showReportInModal] data:', data);
      console.log('üìã [showReportInModal] headers:', headers);
      console.log('üìã [showReportInModal] sheetName:', sheetName);
      console.log('üìã [showReportInModal] data.length:', data?.length);
      console.log('üìã [showReportInModal] Primer registro:', data?.[0]);

      document.getElementById('reportResultsTitle').textContent = nombreHoja;
      const body = document.getElementById('reportResultsBody');

      if (!data || data.length === 0) {
        console.warn('‚ö†Ô∏è [showReportInModal] No hay datos para mostrar');
        body.innerHTML = '<div class="alert alert-info">No hay datos para mostrar en este reporte</div>';
        showModal('reportResultsModal');
        return;
      }

      // Crear tabla con los datos del reporte
      const tableHeaders = headers && headers.length > 0 ? headers : Object.keys(data[0]);
      console.log('üìã [showReportInModal] tableHeaders:', tableHeaders);

      body.innerHTML = `
        <div style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #2563eb;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 0.875rem; color: #64748b;">Reporte:</div>
              <div style="font-weight: 600; color: #1e293b;">${sheetName || nombreHoja}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 0.875rem; color: #64748b;">Total de registros:</div>
              <div style="font-weight: 700; color: #2563eb; font-size: 1.25rem;">${data.length}</div>
            </div>
          </div>
        </div>

        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
          <table>
            <thead style="position: sticky; top: 0; background: var(--bg); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <tr>
                ${tableHeaders.map(h => `<th style="padding: 12px; white-space: nowrap;">${h}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${data.map((row, idx) => {
        try {
          return `
                    <tr style="transition: background 0.2s; ${idx % 2 === 0 ? 'background: #ffffff;' : 'background: #f8fafc;'}">
                      ${tableHeaders.map(h => {
            try {
              const value = row[h];
              const displayValue = value !== null && value !== undefined && value !== '' ? value : '-';

              // Detectar si es un n√∫mero para alinearlo a la derecha
              const isNumber = typeof value === 'number' || (!isNaN(parseFloat(value)) && isFinite(value));
              const alignment = isNumber ? 'text-align: right;' : 'text-align: left;';

              return `<td style="padding: 10px; ${alignment}">${displayValue}</td>`;
            } catch (cellError) {
              console.error('‚ùå Error renderizando celda:', cellError, 'Header:', h, 'Row:', row);
              return `<td style="padding: 10px; color: red;">Error</td>`;
            }
          }).join('')}
                    </tr>
                  `;
        } catch (rowError) {
          console.error('‚ùå Error renderizando fila:', rowError, 'Row:', row);
          return `<tr><td colspan="${tableHeaders.length}" style="color: red;">Error en fila ${idx}</td></tr>`;
        }
      }).join('')}
            </tbody>
          </table>
        </div>

        <div style="margin-top: 16px; padding: 12px; background: #f1f5f9; border-radius: 8px; font-size: 0.875rem; color: #64748b; text-align: center;">
          üí° Este reporte contiene ${data.length} registro${data.length !== 1 ? 's' : ''} y ${tableHeaders.length} columna${tableHeaders.length !== 1 ? 's' : ''}
        </div>
      `;

      console.log('‚úÖ [showReportInModal] Tabla renderizada exitosamente');
      showModal('reportResultsModal');
    }

    async function calculateWeightedAverage() {
      showLoading('Obteniendo hojas de reporte...');

      try {
        // Paso 1: Obtener hojas disponibles
        const hojasResponse = await callBackend('getHojasReportes');
        hideLoading();

        if (!hojasResponse || !hojasResponse.success) {
          showError('Error', hojasResponse?.message || 'No se pudieron obtener las hojas de reporte');
          return;
        }

        const hojas = hojasResponse.data;

        // Crear di√°logo para seleccionar hoja
        const dialog1 = document.createElement('div');
        dialog1.className = 'modal';
        dialog1.innerHTML = `
          <div class="modal-content" style="max-width: 500px;">
            <h3>Calcular Medias Ponderadas</h3>
            <p>Selecciona la hoja de reporte:</p>
            <div class="form-group">
              <select id="select-hoja-reporte" class="form-control">
                ${hojas.map(h => `<option value="${h}">${h}</option>`).join('')}
              </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button class="btn btn-primary" id="btn-siguiente-hoja">Siguiente</button>
              <button class="btn btn-outline" id="btn-cancelar-hoja">Cancelar</button>
            </div>
          </div>
        `;
        document.body.appendChild(dialog1);
        dialog1.classList.add('active');

        document.getElementById('btn-cancelar-hoja').addEventListener('click', () => {
          dialog1.remove();
        });

        document.getElementById('btn-siguiente-hoja').addEventListener('click', async () => {
          const nombreHoja = document.getElementById('select-hoja-reporte').value;
          dialog1.remove();

          // Paso 2: Obtener instrumentos de la hoja seleccionada
          showLoading('Obteniendo instrumentos...');

          try {
            const instResponse = await callBackend('getInstrumentosDeReporte', nombreHoja);
            hideLoading();

            if (!instResponse || !instResponse.success) {
              showError('Error', instResponse?.message || 'No se pudieron obtener los instrumentos');
              return;
            }

            const instrumentos = instResponse.data.instrumentos;

            // Crear di√°logo para ingresar pesos
            const dialog2 = document.createElement('div');
            dialog2.className = 'modal';
            dialog2.innerHTML = `
              <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <h3>Pesos de Instrumentos</h3>
                <p><strong>Hoja:</strong> ${nombreHoja}</p>
                <p>Ingresa el peso (%) para cada instrumento:</p>
                <div id="instrumentos-container">
                  ${instrumentos.map(inst => `
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                      <label style="flex: 1; margin: 0;">${inst}:</label>
                      <input type="number"
                             id="peso-${inst.replace(/[^a-zA-Z0-9]/g, '_')}"
                             class="form-control peso-input"
                             data-instrumento="${inst}"
                             placeholder="0-100"
                             min="0"
                             max="100"
                             step="0.1"
                             style="width: 120px;">
                      <span>%</span>
                    </div>
                  `).join('')}
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                  <button class="btn btn-primary" id="btn-calcular-pesos">Calcular</button>
                  <button class="btn btn-outline" id="btn-cancelar-pesos">Cancelar</button>
                </div>
              </div>
            `;
            document.body.appendChild(dialog2);
            dialog2.classList.add('active');

            document.getElementById('btn-cancelar-pesos').addEventListener('click', () => {
              dialog2.remove();
            });

            document.getElementById('btn-calcular-pesos').addEventListener('click', async () => {
              // Recopilar pesos
              const pesos = {};
              const inputs = document.querySelectorAll('.peso-input');
              let valid = true;

              inputs.forEach(input => {
                const inst = input.getAttribute('data-instrumento');
                const valor = input.value.trim();

                if (!valor) {
                  showError('Error', `Falta el peso para: ${inst}`);
                  valid = false;
                  return;
                }

                const peso = parseFloat(valor);
                if (isNaN(peso) || peso < 0) {
                  showError('Error', `Peso inv√°lido para ${inst}: ${valor}`);
                  valid = false;
                  return;
                }

                pesos[inst] = peso;
              });

              if (!valid) return;

              dialog2.remove();

              // Paso 3: Calcular medias ponderadas
              showLoading('Calculando medias ponderadas...');

              try {
                const calcResponse = await callBackend('calcularMediaPonderada', nombreHoja, pesos);
                hideLoading();

                if (calcResponse && calcResponse.success) {
                  showSuccess(calcResponse.message || 'Medias ponderadas calculadas exitosamente');
                } else {
                  showError('Error', calcResponse?.message || 'No se pudo calcular las medias');
                }
              } catch (err) {
                hideLoading();
                showError('Error al calcular', err.message);
              }
            });

          } catch (err) {
            hideLoading();
            showError('Error', err.message);
          }
        });

      } catch (err) {
        hideLoading();
        showError('Error', err.message);
      }
    }

    async function exportData() {
      showLoading('Obteniendo lista de reportes...');

      try {
        const response = await callBackend('listarReportesExistentes');
        console.log('Respuesta de listarReportesExistentes en exportData:', response);
        hideLoading();

        // Aplicar el mismo unwrapping
        if (!response || !response.success) {
          showError('Error', response?.message || 'No se pudo obtener la lista de reportes');
          return;
        }

        const actualData = response.result || response;
        console.log('Datos despu√©s de unwrap en exportData:', actualData);

        if (!actualData || !actualData.success) {
          showError('Error', actualData?.message || 'No se pudo obtener la lista de reportes');
          return;
        }

        const reportes = actualData.data || [];

        if (reportes.length === 0) {
          showError('Sin reportes', 'No hay reportes generados todav√≠a. Primero genera un reporte para poder exportarlo.');
          return;
        }

        // Crear di√°logo para seleccionar reporte a exportar
        const dialog = document.createElement('div');
        dialog.className = 'modal';

        // Agrupar reportes por tipo
        const reportesPorTipo = {
          notas: reportes.filter(r => r.tipo === 'notas'),
          asistencia_avanzada: reportes.filter(r => r.tipo === 'asistencia_avanzada'),
          asistencia: reportes.filter(r => r.tipo === 'asistencia'),
          comparativa: reportes.filter(r => r.tipo === 'comparativa')
        };

        const formatFecha = (fecha) => {
          try {
            return new Date(fecha).toLocaleString('es-ES', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch {
            return 'Fecha desconocida';
          }
        };

        const crearListaReportes = (listaReportes, titulo, icono) => {
          if (listaReportes.length === 0) return '';
          return `
            <div style="margin-bottom: 20px;">
              <h4 style="color: #2563eb; margin-bottom: 10px;">${icono} ${titulo}</h4>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${listaReportes.map(r => `
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <button
                      class="btn btn-outline"
                      style="text-align: left; padding: 12px; display: flex; justify-content: space-between; align-items: center; flex: 1;"
                      data-reporte-nombre="${r.nombre}"
                      data-accion="exportar"
                    >
                      <div>
                        <div style="font-weight: 600;">${r.nombre}</div>
                        <div style="font-size: 0.85em; color: #64748b; margin-top: 4px;">
                          ${r.tipo === 'notas' ? `${r.info.curso} - ${r.info.situacion}` : r.info.descripcion || r.info.fecha || ''}
                        </div>
                      </div>
                      <div style="font-size: 0.8em; color: #94a3b8;">
                        ${formatFecha(r.ultimaModificacion)}
                      </div>
                    </button>
                    <button
                      class="btn btn-primary"
                      style="padding: 12px 16px; white-space: nowrap;"
                      data-reporte-nombre="${r.nombre}"
                      data-accion="visualizar"
                      title="Visualizar este reporte"
                    >
                      üëÅÔ∏è Visualizar
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        };

        dialog.innerHTML = `
          <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow-y: auto;">
            <h3>Consultar y Exportar Reportes</h3>
            <p style="color: #64748b; margin-bottom: 20px;">
              Selecciona un reporte para visualizarlo o exportarlo en formato PDF
            </p>

            ${crearListaReportes(reportesPorTipo.notas, 'Reportes de Notas', 'üìÑ')}
            ${crearListaReportes(reportesPorTipo.asistencia_avanzada, 'Reportes Avanzados de Asistencia', 'üìä')}
            ${crearListaReportes(reportesPorTipo.asistencia, 'Reportes de Asistencia', '‚úì')}
            ${crearListaReportes(reportesPorTipo.comparativa, 'Comparativas', 'üìà')}

            <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
              <button class="btn btn-outline" id="btn-cancelar-exportar" style="flex: 1;">Cerrar</button>
            </div>
          </div>
        `;

        document.body.appendChild(dialog);
        dialog.classList.add('active');

        // A√±adir manejadores
        const btnCancelar = dialog.querySelector('#btn-cancelar-exportar');
        btnCancelar.addEventListener('click', () => {
          dialog.remove();
        });

        // Manejadores para botones de reportes
        const botonesReportes = dialog.querySelectorAll('[data-reporte-nombre]');
        botonesReportes.forEach(btn => {
          btn.addEventListener('click', async () => {
            const nombreReporte = btn.getAttribute('data-reporte-nombre');
            const accion = btn.getAttribute('data-accion');
            console.log(`üîß [exportData] Bot√≥n clickeado - Acci√≥n: ${accion}, Reporte: ${nombreReporte}`);
            dialog.remove();

            if (accion === 'visualizar') {
              await visualizarReporte(nombreReporte);
            } else if (accion === 'exportar') {
              await exportarReporteSeleccionado(nombreReporte);
            }
          });
        });

        // Cerrar al hacer clic fuera
        dialog.addEventListener('click', (e) => {
          if (e.target === dialog) {
            dialog.remove();
          }
        });

      } catch (err) {
        hideLoading();
        showError('Error al exportar datos', err.message);
      }
    }

    /**
     * Visualizar un reporte en un modal con tabla interactiva
     * @param {string} nombreReporte - Nombre exacto de la hoja del reporte
     */
    async function visualizarReporte(nombreReporte) {
      console.log(`üîß [visualizarReporte] Iniciando visualizaci√≥n de: "${nombreReporte}"`);
      showLoading(`Cargando reporte "${nombreReporte}"...`);

      try {
        // Llamar al backend para obtener los datos del reporte
        const response = await callBackend('leerReporteExistente', nombreReporte);
        console.log(`üìä [visualizarReporte] Respuesta recibida:`, response);
        hideLoading();

        // Validar respuesta
        if (!response || !response.success) {
          const errorMsg = response?.message || 'No se pudo leer el reporte. Verifica que el nombre sea correcto.';
          console.error(`‚ùå [visualizarReporte] Error:`, errorMsg);
          showError('Error al leer reporte', errorMsg);
          return;
        }

        const { data, headers, sheetName, rowCount, colCount, lastModified } = response;
        console.log(`‚úÖ [visualizarReporte] Datos obtenidos - Filas: ${rowCount}, Columnas: ${colCount}`);

        // Validar que haya datos
        if (!data || data.length === 0) {
          console.warn(`‚ö†Ô∏è [visualizarReporte] El reporte "${nombreReporte}" no contiene datos`);
          showError('Reporte vac√≠o', 'Este reporte no contiene datos para mostrar.');
          return;
        }

        // Crear modal para mostrar los datos
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'modalVisualizarReporte';

        // Formatear fecha de √∫ltima modificaci√≥n
        let fechaFormateada = 'Desconocida';
        try {
          if (lastModified) {
            fechaFormateada = new Date(lastModified).toLocaleString('es-ES', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
        } catch (err) {
          console.warn(`‚ö†Ô∏è [visualizarReporte] Error al formatear fecha:`, err);
        }

        // Renderizar tabla con los datos
        console.log(`üìã [visualizarReporte] Renderizando tabla...`);
        const tableHeaders = headers || Object.keys(data[0] || {});
        console.log(`üìã [visualizarReporte] Headers:`, tableHeaders);

        // Generar HTML de la tabla con manejo de errores por celda
        let tableHTML = '';
        try {
          tableHTML = `
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
              <thead>
                <tr style="background: #f8fafc; position: sticky; top: 0; z-index: 10;">
                  ${tableHeaders.map(h => `
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-weight: 600; color: #1e293b;">
                      ${h}
                    </th>
                  `).join('')}
                </tr>
              </thead>
              <tbody>
                ${data.map((row, idx) => {
            try {
              return `
                      <tr style="border-bottom: 1px solid #f1f5f9; ${idx % 2 === 0 ? 'background: #fafafa;' : ''}">
                        ${tableHeaders.map(header => {
                try {
                  const value = row[header];
                  const displayValue = value !== null && value !== undefined && value !== '' ? value : '-';
                  const isNumber = typeof value === 'number' || (!isNaN(value) && value !== '');
                  return `<td style="padding: 10px; ${isNumber ? 'text-align: right;' : ''}">${displayValue}</td>`;
                } catch (cellError) {
                  console.error(`‚ùå [visualizarReporte] Error en celda - Fila ${idx}, Header ${header}:`, cellError);
                  return `<td style="padding: 10px; color: red;">Error</td>`;
                }
              }).join('')}
                      </tr>
                    `;
            } catch (rowError) {
              console.error(`‚ùå [visualizarReporte] Error en fila ${idx}:`, rowError);
              return `<tr><td colspan="${tableHeaders.length}" style="padding: 10px; color: red;">Error en fila ${idx}</td></tr>`;
            }
          }).join('')}
              </tbody>
            </table>
          `;
        } catch (tableError) {
          console.error(`‚ùå [visualizarReporte] Error al generar tabla HTML:`, tableError);
          showError('Error de renderizaci√≥n', 'No se pudo generar la tabla. Revisa la consola para m√°s detalles.');
          return;
        }

        // Crear contenido del modal
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 95vw; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
              <h3 style="margin: 0 0 8px 0; color: #1e293b;">üìä ${sheetName || nombreReporte}</h3>
              <div style="display: flex; gap: 16px; font-size: 0.85em; color: #64748b;">
                <span><strong>Filas:</strong> ${rowCount}</span>
                <span><strong>Columnas:</strong> ${colCount}</span>
                <span><strong>√öltima modificaci√≥n:</strong> ${fechaFormateada}</span>
              </div>
            </div>

            <div style="flex: 1; overflow: auto; padding: 20px;">
              ${tableHTML}
            </div>

            <div style="padding: 16px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 0.85em; color: #64748b;">
                Total de registros: ${rowCount}
              </div>
              <button class="btn btn-outline" onclick="document.getElementById('modalVisualizarReporte').remove()">
                Cerrar
              </button>
            </div>
          </div>
        `;

        // A√±adir modal al DOM y mostrarlo
        document.body.appendChild(modal);
        modal.classList.add('active');
        console.log(`‚úÖ [visualizarReporte] Modal renderizado exitosamente`);

        // Cerrar al hacer clic fuera del modal
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });

        // Cerrar con tecla Escape
        const escapeHandler = (e) => {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escapeHandler);
          }
        };
        document.addEventListener('keydown', escapeHandler);

      } catch (err) {
        hideLoading();
        console.error(`‚ùå [visualizarReporte] Excepci√≥n capturada:`, err);
        console.error(`Stack:`, err.stack);
        showError('Error al visualizar reporte', err.message || 'Error desconocido. Revisa la consola para m√°s detalles.');
      }
    }

    async function exportarReporteSeleccionado(nombreReporte) {
      showLoading(`Generando PDF de "${nombreReporte}"...`);

      try {
        const response = await callBackend('exportarReportePDF', nombreReporte);
        hideLoading();

        if (!response || !response.success) {
          showError('Error', response?.message || 'No se pudo generar el PDF');
          return;
        }

        // Abrir el PDF en una nueva pesta√±a
        window.open(response.url, '_blank');

        showSuccess(
          'PDF Generado',
          `El reporte "${nombreReporte}" se ha exportado correctamente. Se abrir√° en una nueva pesta√±a.`
        );

      } catch (err) {
        hideLoading();
        showError('Error al generar PDF', err.message);
      }
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    /**
     * Initialize the dashboard when DOM is ready
     */
    function initializeDashboard() {
      console.log('Initializing dashboard...');
      console.log('Mode:', isModalMode ? 'Modal Dialog' : 'Web App');

      // Show mode indicator (optional, can be hidden in production)
      const modeIndicator = document.getElementById('modeIndicator');
      if (modeIndicator) {
        modeIndicator.textContent = isModalMode ? 'üîπ Modal Mode' : 'üåê Web App Mode';
        // Uncomment to show mode indicator:
        // modeIndicator.style.display = 'block';
      }

      // Load initial statistics
      loadStats().catch(err => {
        console.error('Error loading initial stats:', err);
        showError('No se pudieron cargar las estad√≠sticas iniciales',
          'Por favor, verifica tu conexi√≥n y recarga la p√°gina.');
      });

      // Setup modal click-outside-to-close behavior
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal.id);
          }
        });
      });

      // Add Enter key support for inputs
      const inputs = document.querySelectorAll('.form-input');
      inputs.forEach(input => {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const modal = input.closest('.modal');
            if (modal) {
              const confirmButton = modal.querySelector('.btn-primary');
              if (confirmButton) {
                confirmButton.click();
              }
            }
          }
        });
      });

      // Add Escape key support for closing modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const activeModal = document.querySelector('.modal.active');
          if (activeModal) {
            closeModal(activeModal.id);
          }
        }
      });

      console.log('Dashboard initialized successfully');
    }

    // ============================================================================
    // EVALUATION SECTION FUNCTIONS
    // ============================================================================

    let evaluationData = {
      selectedCourse: null,
      selectedInstrument: null,
      instrumentDetails: null,
      selectedStudents: [],
      allStudents: [],
      currentMode: 'new', // 'new' or 'review'
      reviewData: {
        selectedCourse: null,
        selectedInstrument: null,
        evaluations: []
      }
    };

    /**
     * Switch between evaluation modes
     */
    function switchEvaluationMode(mode) {
      evaluationData.currentMode = mode;

      // Update tab styles
      document.querySelectorAll('.evaluation-mode-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(mode === 'new' ? 'newEvaluationModeBtn' : 'reviewEvaluationModeBtn').classList.add('active');

      // Show/hide content
      document.getElementById('newEvaluationMode').style.display = mode === 'new' ? 'block' : 'none';
      document.getElementById('reviewEvaluationMode').style.display = mode === 'review' ? 'block' : 'none';

      // Load data for the selected mode
      if (mode === 'review') {
        loadReviewCourses();
      }
    }

    /**
     * Load courses for evaluation section
     */
    async function loadEvaluationCourses() {
      try {
        const courses = await callBackend('getCourses');
        const select = document.getElementById('evaluateCourseSelect');
        select.innerHTML = '<option value="">Selecciona un curso...</option>';

        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course;
          option.textContent = course;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading courses:', error);
        showError('Error al cargar cursos', error.message);
      }
    }

    /**
     * Handle course selection change
     */
    async function onEvaluateCourseChange() {
      const courseSelect = document.getElementById('evaluateCourseSelect');
      const instrumentSelect = document.getElementById('evaluateInstrumentSelect');
      const course = courseSelect.value;

      evaluationData.selectedCourse = course;
      evaluationData.selectedInstrument = null;
      evaluationData.selectedStudents = [];

      // Reset instrument selection
      instrumentSelect.innerHTML = '<option value="">Cargando instrumentos...</option>';
      document.getElementById('evaluateInstrumentInfo').style.display = 'none';
      document.getElementById('evaluateStudentsList').style.display = 'none';

      if (!course) {
        instrumentSelect.innerHTML = '<option value="">Primero selecciona un curso...</option>';
        return;
      }

      try {
        console.log('[onEvaluateCourseChange] Cargando instrumentos para curso:', course);
        showLoading('Cargando instrumentos...');
        const instruments = await callBackend('getInstrumentsByCourse', course);
        hideLoading();

        console.log('[onEvaluateCourseChange] Instrumentos recibidos:', instruments);
        console.log('[onEvaluateCourseChange] Total instrumentos:', instruments.length);

        instrumentSelect.innerHTML = '<option value="">‚úì Selecciona un instrumento...</option>';

        if (instruments.length === 0) {
          console.warn('[onEvaluateCourseChange] No se encontraron instrumentos para este curso');
          instrumentSelect.innerHTML = '<option value="">‚ö† No hay instrumentos disponibles para este curso</option>';
          return;
        }

        instruments.forEach(instrument => {
          console.log('[onEvaluateCourseChange] Agregando instrumento:', instrument.nombre);
          const option = document.createElement('option');
          option.value = instrument.id;
          option.textContent = `${instrument.nombre} (${instrument.tipo})`;
          option.dataset.instrument = JSON.stringify(instrument);
          instrumentSelect.appendChild(option);
        });

        console.log('[onEvaluateCourseChange] ‚úÖ Instrumentos cargados exitosamente');
      } catch (error) {
        hideLoading();
        console.error('[onEvaluateCourseChange] ‚ùå Error loading instruments:', error);
        console.error('[onEvaluateCourseChange] Error stack:', error.stack);
        showError('Error al cargar instrumentos', error.message);
        instrumentSelect.innerHTML = '<option value="">‚ùå Error al cargar instrumentos</option>';
      }
    }

    /**
     * Handle instrument selection change
     */
    async function onEvaluateInstrumentChange() {
      const instrumentSelect = document.getElementById('evaluateInstrumentSelect');
      const selectedOption = instrumentSelect.options[instrumentSelect.selectedIndex];

      if (!selectedOption || !selectedOption.dataset.instrument) {
        document.getElementById('evaluateInstrumentInfo').style.display = 'none';
        document.getElementById('evaluateStudentsList').style.display = 'none';
        evaluationData.selectedInstrument = null;
        return;
      }

      const instrument = JSON.parse(selectedOption.dataset.instrument);
      evaluationData.selectedInstrument = instrument.id;
      evaluationData.instrumentDetails = instrument;

      // Show instrument info
      const infoDiv = document.getElementById('evaluateInstrumentInfo');
      const detailsDiv = document.getElementById('evaluateInstrumentDetails');
      detailsDiv.innerHTML = `
        <strong>Nombre:</strong> ${instrument.nombre}<br>
        <strong>Tipo:</strong> ${instrument.tipo}<br>
        <strong>Situaci√≥n:</strong> ${instrument.situacionAprendizaje || 'N/A'}
      `;
      infoDiv.style.display = 'block';

      // Load students for this course
      try {
        console.log('[onEvaluateInstrumentChange] Cargando estudiantes para curso:', evaluationData.selectedCourse);
        showLoading('Cargando estudiantes...');

        const students = await callBackend('getStudentsByCourse', evaluationData.selectedCourse);
        console.log('[onEvaluateInstrumentChange] Estudiantes recibidos:', students);

        // Verificar si hay estudiantes
        if (!students || students.length === 0) {
          hideLoading();
          console.warn('[onEvaluateInstrumentChange] No se encontraron estudiantes para este curso');
          showError(
            'No hay estudiantes',
            `No se encontraron estudiantes para el curso "${evaluationData.selectedCourse}". Verifica que los estudiantes est√©n registrados en la hoja "Estudiantes".`
          );
          document.getElementById('evaluateStudentsList').style.display = 'none';
          return;
        }

        evaluationData.allStudents = students;
        hideLoading();

        // Check which students have been evaluated
        console.log('[onEvaluateInstrumentChange] Verificando evaluaciones previas para instrumento:', instrument.id);
        const evaluations = await callBackend('getEvaluationsByInstrument', instrument.id);
        const evaluatedStudentIds = new Set(evaluations.map(e => e.studentId));
        console.log('[onEvaluateInstrumentChange] Estudiantes ya evaluados:', Array.from(evaluatedStudentIds));

        // Render students table
        renderEvaluateStudentsTable(students, evaluatedStudentIds);
        document.getElementById('evaluateStudentsList').style.display = 'block';
      } catch (error) {
        hideLoading();
        console.error('[onEvaluateInstrumentChange] Error completo:', error);
        console.error('[onEvaluateInstrumentChange] Stack:', error.stack);
        showError('Error al cargar estudiantes', error.message || 'Error desconocido al cargar los estudiantes');
        document.getElementById('evaluateStudentsList').style.display = 'none';
      }
    }

    /**
     * Render students table for evaluation
     */
    function renderEvaluateStudentsTable(students, evaluatedStudentIds) {
      const tbody = document.getElementById('evaluateStudentsTableBody');
      tbody.innerHTML = '';

      students.forEach(student => {
        const isEvaluated = evaluatedStudentIds.has(student.id);
        const row = document.createElement('tr');
        row.style.background = isEvaluated ? 'rgba(16, 185, 129, 0.05)' : 'transparent';

        row.innerHTML = `
          <td style="text-align: center; padding: 1rem;">
            <input type="checkbox"
                   class="student-checkbox"
                   value="${student.id}"
                   data-student='${JSON.stringify(student)}'
                   onchange="onStudentCheckboxChange()"
                   style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
          </td>
          <td style="padding: 1rem;">
            <div style="font-weight: 500;">${student.nombre}</div>
            <div style="font-size: 0.875rem; color: var(--text-light);">${student.email || ''}</div>
          </td>
          <td style="text-align: center; padding: 1rem;">
            ${isEvaluated ? '<span style="color: var(--secondary); font-weight: 500;">‚úì Evaluado</span>' : '<span style="color: var(--text-light);">Pendiente</span>'}
          </td>
          <td style="text-align: center; padding: 1rem;">
            <button class="btn btn-outline" 
                    style="padding: 0.5rem 0.75rem; font-size: 0.875rem;" 
                    onclick='selectSingleStudent(${JSON.stringify(student)}, ${isEvaluated})'>
              ${isEvaluated ? 'Revisar' : 'Evaluar'}
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });

      updateSelectedCount();
    }

    /**
     * Handle student checkbox change
     */
    function onStudentCheckboxChange() {
      const checkboxes = document.querySelectorAll('.student-checkbox:checked');
      evaluationData.selectedStudents = Array.from(checkboxes).map(cb => JSON.parse(cb.dataset.student));

      updateSelectedCount();
      updateSelectAllCheckbox();
    }

    /**
     * Update selected students count
     */
    function updateSelectedCount() {
      const count = evaluationData.selectedStudents.length;
      const countSpan = document.getElementById('selectedStudentsCount');
      const openBtn = document.getElementById('openEvaluationBtn');

      if (count > 0) {
        countSpan.textContent = `${count} estudiante${count > 1 ? 's' : ''} seleccionado${count > 1 ? 's' : ''}`;
        openBtn.disabled = false;
      } else {
        countSpan.textContent = '';
        openBtn.disabled = true;
      }
    }

    /**
     * Update "select all" checkbox state
     */
    function updateSelectAllCheckbox() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const checkboxes = document.querySelectorAll('.student-checkbox');
      const checkedCheckboxes = document.querySelectorAll('.student-checkbox:checked');

      if (checkboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCheckboxes.length === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
      } else if (checkedCheckboxes.length > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
      } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
      }
    }

    /**
     * Toggle all students selection
     */
    function toggleAllStudents() {
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      const checkboxes = document.querySelectorAll('.student-checkbox');

      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });

      onStudentCheckboxChange();
    }

    /**
     * Select all students
     */
    function selectAllStudents() {
      const checkboxes = document.querySelectorAll('.student-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
      onStudentCheckboxChange();
    }

    /**
     * Clear student selection
     */
    function clearStudentSelection() {
      const checkboxes = document.querySelectorAll('.student-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
      onStudentCheckboxChange();
    }

    /**
     * Select a single student for evaluation
     */
    async function selectSingleStudent(student, isEvaluated = false) {
      evaluationData.selectedStudents = [student];

      // Uncheck all checkboxes
      const checkboxes = document.querySelectorAll('.student-checkbox');
      checkboxes.forEach(cb => cb.checked = false);

      // Check only the selected student
      const checkbox = document.querySelector(`.student-checkbox[value="${student.id}"]`);
      if (checkbox) checkbox.checked = true;

      updateSelectedCount();
      updateSelectAllCheckbox();

      // If reviewing, fetch existing data
      let existingData = null;
      if (isEvaluated) {
        try {
          showLoading('Cargando evaluaci√≥n...');
          const response = await callBackend('getEvaluationDetails', student.id, evaluationData.selectedInstrument);
          hideLoading();

          if (response && response.success && response.found) {
            existingData = response;
          } else {
            console.warn('Evaluaci√≥n marcada como existente pero no encontrada en detalle');
          }
        } catch (error) {
          hideLoading();
          console.error('Error fetching evaluation details:', error);
          showError('Error al cargar detalles de la evaluaci√≥n');
        }
      }

      // Open evaluation panel
      openEvaluationPanel(existingData);
    }

    /**
     * Open evaluation panel
     */
    /**
     * Open evaluation panel
     */
    function openEvaluationPanel(existingData = null) {
      if (evaluationData.selectedStudents.length === 0) {
        showError('Por favor, selecciona al menos un estudiante');
        return;
      }

      if (!evaluationData.instrumentDetails) {
        showError('No hay instrumento seleccionado');
        return;
      }

      // Update panel subtitle
      const subtitle = document.getElementById('evaluationPanelSubtitle');
      subtitle.textContent = `${evaluationData.instrumentDetails.nombre} - ${evaluationData.instrumentDetails.tipo}`;

      // Update students list
      const studentsList = document.getElementById('evaluationStudentsList');
      studentsList.innerHTML = evaluationData.selectedStudents
        .map(s => `<div style="padding: 0.25rem 0;">‚Ä¢ ${s.nombre}</div>`)
        .join('');

      // Generate evaluation form
      generateEvaluationForm(existingData);

      // Show panel
      document.getElementById('evaluationPanel').classList.add('active');
      document.getElementById('evaluationPanelOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    /**
     * Close evaluation panel
     */
    function closeEvaluationPanel() {
      document.getElementById('evaluationPanel').classList.remove('active');
      document.getElementById('evaluationPanelOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }

    /**
     * Generate evaluation form based on instrument type
     */
    /**
     * Generate evaluation form based on instrument type
     */
    function generateEvaluationForm(existingData = null) {
      const formDiv = document.getElementById('evaluationForm');
      const instrument = evaluationData.instrumentDetails;

      if (instrument.tipo === 'R√∫brica') {
        generateRubricForm(formDiv, instrument, existingData);
      } else if (instrument.tipo === 'Lista de Cotejo') {
        generateChecklistForm(formDiv, instrument, existingData);
      } else if (instrument.tipo === 'Calificaci√≥n Directa') {
        generateDirectGradeForm(formDiv, instrument, existingData);
      }
    }

    /**
     * Generate rubric evaluation form
     */
    /**
     * Generate rubric evaluation form
     */
    function generateRubricForm(container, instrument, existingData = null) {
      const criteria = instrument.criterios || [];
      const notes = existingData && existingData.notas ? existingData.notas : '';
      const finalGrade = existingData && existingData.resultado && existingData.resultado.calificacion !== undefined
        ? existingData.resultado.calificacion
        : null;

      // Extraer criterios guardados y crear un mapa por nombre
      let savedCriteria = {};
      if (existingData && existingData.resultado && existingData.resultado.criterios) {
        console.log('[generateRubricForm] Criterios guardados encontrados:', existingData.resultado.criterios);

        // Convertir el array de criterios guardados en un mapa por nombre
        existingData.resultado.criterios.forEach(crit => {
          savedCriteria[crit.nombre] = {
            nivel: crit.nivel,
            puntos: crit.puntos
          };
        });

        console.log('[generateRubricForm] Mapa de criterios guardados:', savedCriteria);
      }

      container.innerHTML = `
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
          <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0;">R√∫brica de Evaluaci√≥n</h4>
          ${finalGrade !== null ? `
            <div style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">
              Nota Final: ${Number(finalGrade).toFixed(2)}
            </div>
          ` : ''}
        </div>
        <p style="font-size: 0.875rem; color: var(--text-light);">Selecciona el nivel de desempe√±o para cada criterio</p>
        ${criteria.map((criterio, index) => {
        // Buscar si este criterio tiene un valor guardado por nombre
        const savedData = savedCriteria[criterio.nombre];

        console.log(`[generateRubricForm] Criterio "${criterio.nombre}" - Guardado:`, savedData);

        return `
          <div class="evaluation-criterion">
            <div class="evaluation-criterion-title">${index + 1}. ${criterio.nombre}</div>
            <div class="evaluation-levels">
              ${criterio.niveles.map(nivel => {
          // Marcar como seleccionado si coincide con el nivel guardado (por nombre)
          const isChecked = savedData && savedData.nivel === nivel.nombre ? 'checked' : '';

          console.log(`[generateRubricForm]   Nivel "${nivel.nombre}" - Checked: ${isChecked}`);

          return `
                <div class="evaluation-level">
                  <input type="radio"
                         id="criterio_${index}_${nivel.valor}"
                         name="criterio_${index}"
                         value="${nivel.valor}"
                         data-puntos="${nivel.puntos}"
                         data-nivel-nombre="${nivel.nombre}"
                         data-criterio-nombre="${criterio.nombre}"
                         ${isChecked}>
                  <label for="criterio_${index}_${nivel.valor}">
                    ${nivel.nombre}<br>
                    <span style="font-size: 0.75rem; opacity: 0.8;">(${nivel.puntos} pts)</span>
                  </label>
                </div>
              `}).join('')}
            </div>
          </div>
        `}).join('')}
        <div class="evaluation-notes">
          <label class="form-label">Observaciones (opcional)</label>
          <textarea id="evaluationNotes" placeholder="A√±ade comentarios sobre la evaluaci√≥n...">${notes}</textarea>
        </div>
      `;
    }

    /**
     * Generate checklist evaluation form
     */
    /**
     * Generate checklist evaluation form
     */
    function generateChecklistForm(container, instrument, existingData = null) {
      const items = instrument.items || [];
      const results = existingData && existingData.resultado ? existingData.resultado : {};
      const notes = existingData && existingData.notas ? existingData.notas : '';
      const finalGrade = existingData && existingData.resultado && existingData.resultado.calificacion !== undefined
        ? existingData.resultado.calificacion
        : null;

      container.innerHTML = `
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
          <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0;">Lista de Cotejo</h4>
          ${finalGrade !== null ? `
            <div style="background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">
              Nota Final: ${Number(finalGrade).toFixed(2)}
            </div>
          ` : ''}
        </div>
        <p style="font-size: 0.875rem; color: var(--text-light);">Marca los elementos completados</p>
        ${items.map((item, index) => {
        const isChecked = results[`item_${index}`] ? 'checked' : '';
        return `
          <div class="evaluation-criterion">
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
              <input type="checkbox"
                     id="item_${index}"
                     name="item_${index}"
                     value="1"
                     style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary);"
                     ${isChecked}>
              <span style="flex: 1;">${item.descripcion}</span>
            </label>
          </div>
        `}).join('')}
        <div class="evaluation-notes">
          <label class="form-label">Observaciones (opcional)</label>
          <textarea id="evaluationNotes" placeholder="A√±ade comentarios sobre la evaluaci√≥n...">${notes}</textarea>
        </div>
      `;
    }

    /**
     * Generate direct grade evaluation form
     */
    /**
     * Generate direct grade evaluation form
     */
    function generateDirectGradeForm(container, instrument, existingData = null) {
      const results = existingData && existingData.resultado ? existingData.resultado : {};
      const notes = existingData && existingData.notas ? existingData.notas : '';
      const grade = results.calificacion !== undefined ? results.calificacion : '';

      container.innerHTML = `
        <div style="margin-bottom: 1rem;">
          <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">Calificaci√≥n Directa</h4>
          <p style="font-size: 0.875rem; color: var(--text-light);">Introduce la calificaci√≥n num√©rica</p>
        </div>
        <div class="form-group">
          <label class="form-label">Calificaci√≥n (0-10)</label>
          <input type="number"
                 id="directGrade"
                 class="form-input"
                 min="0"
                 max="10"
                 step="0.1"
                 placeholder="Ej: 8.5"
                 value="${grade}"
                 required>
        </div>
        <div class="evaluation-notes">
          <label class="form-label">Observaciones (opcional)</label>
          <textarea id="evaluationNotes" placeholder="A√±ade comentarios sobre la evaluaci√≥n...">${notes}</textarea>
        </div>
      `;
    }

    /**
     * Save evaluation
     */
    async function saveEvaluation() {
      try {
        const instrument = evaluationData.instrumentDetails;
        const notes = document.getElementById('evaluationNotes')?.value || '';

        let evaluationResult;

        if (instrument.tipo === 'R√∫brica') {
          evaluationResult = collectRubricData();
        } else if (instrument.tipo === 'Lista de Cotejo') {
          evaluationResult = collectChecklistData();
        } else if (instrument.tipo === 'Calificaci√≥n Directa') {
          evaluationResult = collectDirectGradeData();
        }

        if (!evaluationResult) {
          showError('Por favor, completa todos los campos requeridos');
          return;
        }

        showLoading('Guardando evaluaci√≥n...');

        // Save evaluation for each selected student
        for (const student of evaluationData.selectedStudents) {
          const evaluationData = {
            studentId: student.id,
            studentName: student.nombre,
            instrumentId: instrument.id,
            instrumentName: instrument.nombre,
            course: evaluationData.selectedCourse,
            tipo: instrument.tipo,
            resultado: evaluationResult,
            notes: notes,
            fecha: new Date().toISOString()
          };

          await callBackend('saveEvaluation', evaluationData);
        }

        hideLoading();
        showSuccess(`Evaluaci√≥n guardada para ${evaluationData.selectedStudents.length} estudiante(s)`);

        // Close panel and refresh
        closeEvaluationPanel();
        onEvaluateInstrumentChange();

      } catch (error) {
        hideLoading();
        console.error('Error saving evaluation:', error);
        showError('Error al guardar la evaluaci√≥n', error.message);
      }
    }

    /**
     * Collect rubric evaluation data
     */
    function collectRubricData() {
      const criteria = evaluationData.instrumentDetails.criterios || [];
      const results = [];
      let totalPoints = 0;

      for (let i = 0; i < criteria.length; i++) {
        const selected = document.querySelector(`input[name="criterio_${i}"]:checked`);
        if (!selected) {
          showError(`Por favor, eval√∫a el criterio: ${criteria[i].nombre}`);
          return null;
        }

        const points = parseFloat(selected.dataset.puntos);
        totalPoints += points;

        results.push({
          criterio: criteria[i].nombre,
          nivel: selected.value,
          puntos: points
        });
      }

      return {
        criterios: results,
        puntosTotales: totalPoints,
        calificacion: totalPoints
      };
    }

    /**
     * Collect checklist evaluation data
     */
    function collectChecklistData() {
      const items = evaluationData.instrumentDetails.items || [];
      const results = [];
      let completedCount = 0;

      items.forEach((item, index) => {
        const checked = document.getElementById(`item_${index}`)?.checked || false;
        if (checked) completedCount++;

        results.push({
          item: item.descripcion,
          completado: checked
        });
      });

      return {
        items: results,
        completados: completedCount,
        total: items.length,
        porcentaje: (completedCount / items.length * 100).toFixed(2)
      };
    }

    /**
     * Collect direct grade evaluation data
     */
    function collectDirectGradeData() {
      const gradeInput = document.getElementById('directGrade');
      const grade = parseFloat(gradeInput?.value);

      if (isNaN(grade) || grade < 0 || grade > 10) {
        showError('Por favor, introduce una calificaci√≥n v√°lida entre 0 y 10');
        return null;
      }

      return {
        calificacion: grade
      };
    }

    /**
     * Duplicate evaluation to another student
     */
    async function duplicateEvaluation() {
      try {
        // Get current form data
        const instrument = evaluationData.instrumentDetails;
        let currentData;

        if (instrument.tipo === 'R√∫brica') {
          currentData = collectRubricData();
        } else if (instrument.tipo === 'Lista de Cotejo') {
          currentData = collectChecklistData();
        } else if (instrument.tipo === 'Calificaci√≥n Directa') {
          currentData = collectDirectGradeData();
        }

        if (!currentData) {
          showError('Por favor, completa la evaluaci√≥n antes de duplicar');
          return;
        }

        // Get students not currently selected
        const availableStudents = evaluationData.allStudents.filter(
          s => !evaluationData.selectedStudents.some(selected => selected.id === s.id)
        );

        if (availableStudents.length === 0) {
          showError('No hay m√°s estudiantes disponibles para duplicar');
          return;
        }

        // Create modal for student selection
        showDuplicateModal(availableStudents, currentData);

      } catch (error) {
        console.error('Error duplicating evaluation:', error);
        showError('Error al duplicar evaluaci√≥n', error.message);
      }
    }

    /**
     * Show modal for duplicating evaluation
     */
    function showDuplicateModal(students, evaluationData) {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.id = 'duplicateEvaluationModal';

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h3 class="modal-title">Duplicar Evaluaci√≥n</h3>
            <button class="modal-close" onclick="closeModal('duplicateEvaluationModal')">√ó</button>
          </div>
          <div class="modal-body">
            <p style="margin-bottom: 1rem; color: var(--text-light);">
              Selecciona el estudiante al que quieres copiar esta evaluaci√≥n:
            </p>
            <div class="form-group">
              <label class="form-label">Estudiante</label>
              <select class="form-select" id="duplicateStudentSelect" required>
                <option value="">Selecciona un estudiante...</option>
                ${students.map(s => `<option value="${s.id}" data-student='${JSON.stringify(s)}'>${s.nombre}</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('duplicateEvaluationModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmDuplicate()">Duplicar</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Store evaluation data for duplication
      window.tempDuplicateData = evaluationData;
    }

    /**
     * Confirm duplication
     */
    async function confirmDuplicate() {
      const select = document.getElementById('duplicateStudentSelect');
      const selectedOption = select.options[select.selectedIndex];

      if (!selectedOption || !selectedOption.value) {
        showError('Por favor, selecciona un estudiante');
        return;
      }

      const student = JSON.parse(selectedOption.dataset.student);
      const evaluationResult = window.tempDuplicateData;
      const notes = document.getElementById('evaluationNotes')?.value || '';

      try {
        showLoading('Duplicando evaluaci√≥n...');

        const evalPayload = {
          studentId: student.id,
          studentName: student.nombre,
          instrumentId: evaluationData.instrumentDetails.id,
          instrumentName: evaluationData.instrumentDetails.nombre,
          course: evaluationData.selectedCourse,
          tipo: evaluationData.instrumentDetails.tipo,
          resultado: evaluationResult,
          notes: notes + ' (Duplicado)',
          fecha: new Date().toISOString()
        };

        await callBackend('saveEvaluation', evalPayload);

        hideLoading();
        closeModal('duplicateEvaluationModal');
        showSuccess(`Evaluaci√≥n duplicada para ${student.nombre}`);

        // Refresh the student list
        onEvaluateInstrumentChange();

      } catch (error) {
        hideLoading();
        console.error('Error duplicating evaluation:', error);
        showError('Error al duplicar evaluaci√≥n', error.message);
      }
    }

    // ============================================================================
    // REVIEW EVALUATION MODE FUNCTIONS
    // ============================================================================

    /**
     * Load courses for review mode
     */
    async function loadReviewCourses() {
      try {
        const courses = await callBackend('getCourses');
        const select = document.getElementById('reviewCourseSelect');
        select.innerHTML = '<option value="">Selecciona un curso...</option>';

        courses.forEach(course => {
          const option = document.createElement('option');
          option.value = course;
          option.textContent = course;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading review courses:', error);
        showError('Error al cargar cursos', error.message);
      }
    }

    /**
     * Handle review course selection
     */
    async function onReviewCourseChange() {
      const courseSelect = document.getElementById('reviewCourseSelect');
      const course = courseSelect.value;

      if (!course) {
        document.getElementById('reviewInstrumentInfo').style.display = 'none';
        document.getElementById('reviewEvaluationsList').style.display = 'none';
        document.getElementById('reviewEmptyState').style.display = 'none';
        return;
      }

      evaluationData.reviewData.selectedCourse = course;

      try {
        showLoading('Cargando instrumentos...');
        const instruments = await callBackend('getInstrumentsByCourse', course);
        hideLoading();

        const instrumentSelect = document.getElementById('reviewInstrumentSelect');
        instrumentSelect.innerHTML = '<option value="">Selecciona un instrumento...</option>';

        instruments.forEach(inst => {
          const option = document.createElement('option');
          option.value = inst.id;
          option.textContent = `${inst.nombre} (${inst.tipo})`;
          option.dataset.instrument = JSON.stringify(inst);
          instrumentSelect.appendChild(option);
        });

        instrumentSelect.disabled = false;
      } catch (error) {
        hideLoading();
        console.error('Error loading instruments:', error);
        showError('Error al cargar instrumentos', error.message);
      }
    }

    /**
     * Handle review instrument selection
     */
    async function onReviewInstrumentChange() {
      const instrumentSelect = document.getElementById('reviewInstrumentSelect');
      const instrumentId = instrumentSelect.value;

      if (!instrumentId) {
        document.getElementById('reviewInstrumentInfo').style.display = 'none';
        document.getElementById('reviewEvaluationsList').style.display = 'none';
        document.getElementById('reviewEmptyState').style.display = 'none';
        return;
      }

      const selectedOption = instrumentSelect.options[instrumentSelect.selectedIndex];
      const instrument = JSON.parse(selectedOption.dataset.instrument);

      evaluationData.reviewData.selectedInstrument = instrument;

      // Show instrument info
      const infoDiv = document.getElementById('reviewInstrumentInfo');
      const detailsDiv = document.getElementById('reviewInstrumentDetails');
      detailsDiv.innerHTML = `
        <strong>${instrument.nombre}</strong><br>
        <span>Tipo: ${instrument.tipo}</span> |
        <span>Situaci√≥n: ${instrument.situacionAprendizaje || 'N/A'}</span>
      `;
      infoDiv.style.display = 'block';

      // Load evaluations for this instrument
      await loadReviewEvaluations();
    }

    /**
     * Load evaluations for selected instrument
     */
    async function loadReviewEvaluations() {
      const instrumentId = evaluationData.reviewData.selectedInstrument.id;

      try {
        showLoading('Cargando evaluaciones...');
        const evaluations = await callBackend('getEvaluationsByInstrumentDetailed', instrumentId);
        hideLoading();

        evaluationData.reviewData.evaluations = evaluations;

        if (evaluations.length === 0) {
          document.getElementById('reviewEvaluationsList').style.display = 'none';
          document.getElementById('reviewEmptyState').style.display = 'block';
        } else {
          document.getElementById('reviewEmptyState').style.display = 'none';
          document.getElementById('reviewEvaluationsList').style.display = 'block';
          renderReviewEvaluationsTable(evaluations);
        }
      } catch (error) {
        hideLoading();
        console.error('Error loading evaluations:', error);
        showError('Error al cargar evaluaciones', error.message);
      }
    }

    /**
     * Render review evaluations table
     */
    function renderReviewEvaluationsTable(evaluations) {
      const tbody = document.getElementById('reviewEvaluationsTableBody');
      const countSpan = document.getElementById('reviewEvaluationsCount');

      countSpan.textContent = `(${evaluations.length} evaluaciones)`;

      tbody.innerHTML = evaluations.map(eval => {
        const date = eval.fecha ? new Date(eval.fecha).toLocaleDateString('es-ES') : 'N/A';
        const calificacion = eval.calificacion !== undefined ? eval.calificacion.toFixed(2) : 'N/A';

        return `
          <tr data-student-name="${eval.studentName.toLowerCase()}">
            <td style="padding: 1rem; border-bottom: 1px solid var(--border);">
              <div style="font-weight: 600;">${eval.studentName}</div>
              ${eval.studentId ? `<div style="font-size: 0.75rem; color: var(--text-light);">ID: ${eval.studentId}</div>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid var(--border); text-align: center;">
              <span style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--secondary); color: white; border-radius: 20px; font-weight: 600;">
                ${calificacion}
              </span>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid var(--border); text-align: center;">
              ${date}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid var(--border); text-align: center;">
              <div style="display: flex; gap: 0.5rem; justify-content: center;">
                <button class="btn btn-outline" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;"
                  onclick='viewEvaluationDetails(${JSON.stringify(eval).replace(/'/g, "&apos;")})'>
                  üëÅÔ∏è Ver
                </button>
                <button class="btn btn-primary" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;"
                  onclick='editEvaluation(${JSON.stringify(eval).replace(/'/g, "&apos;")})'>
                  ‚úèÔ∏è Editar
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    /**
     * Filter review evaluations by search
     */
    function filterReviewEvaluations() {
      const searchInput = document.getElementById('reviewSearchInput');
      const searchTerm = searchInput.value.toLowerCase();
      const rows = document.querySelectorAll('#reviewEvaluationsTableBody tr');

      rows.forEach(row => {
        const studentName = row.dataset.studentName;
        if (studentName.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    /**
     * View evaluation details (read-only)
     */
    function viewEvaluationDetails(evaluation) {
      // Open evaluation panel in read-only mode
      openEvaluationPanelForReview(evaluation, true);
    }

    /**
     * Edit evaluation (editable mode)
     */
    function editEvaluation(evaluation) {
      // Open evaluation panel in edit mode
      openEvaluationPanelForReview(evaluation, false);
    }

    /**
     * Open evaluation panel for review/edit
     */
    function openEvaluationPanelForReview(evaluation, readOnly = false) {
      const instrument = evaluationData.reviewData.selectedInstrument;

      // Update subtitle
      const subtitle = document.getElementById('evaluationPanelSubtitle');
      subtitle.textContent = `${instrument.nombre} - ${evaluation.studentName} ${readOnly ? '(Solo lectura)' : '(Editar)'}`;

      // Update students info
      const studentsInfo = document.getElementById('evaluationStudentsInfo');
      const studentsList = document.getElementById('evaluationStudentsList');
      studentsList.innerHTML = `<div style="font-size: 0.875rem;">${evaluation.studentName}</div>`;
      studentsInfo.style.display = 'block';

      // Generate form based on instrument type
      const formContainer = document.getElementById('evaluationForm');
      formContainer.innerHTML = '';

      // Store evaluation data for later update
      window.currentReviewEvaluation = evaluation;

      if (instrument.tipo === 'R√∫brica') {
        generateRubricForm(formContainer, instrument, evaluation.resultado);
      } else if (instrument.tipo === 'Lista de Cotejo') {
        generateChecklistForm(formContainer, instrument, evaluation.resultado);
      } else if (instrument.tipo === 'Calificaci√≥n Directa') {
        generateDirectGradeForm(formContainer, instrument, evaluation.resultado);
      }

      // Add notes field
      const notesHtml = `
        <div class="evaluation-notes" style="margin-top: 1.5rem;">
          <label class="form-label">Observaciones generales</label>
          <textarea id="evaluationNotes" style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.875rem; resize: vertical;" ${readOnly ? 'readonly' : ''}>${evaluation.notas || ''}</textarea>
        </div>
      `;
      formContainer.insertAdjacentHTML('beforeend', notesHtml);

      // Disable all inputs if read-only
      if (readOnly) {
        formContainer.querySelectorAll('input, textarea, select').forEach(el => {
          el.disabled = true;
        });
      }

      // Update action buttons
      const saveBtn = document.getElementById('saveEvaluationBtn');
      const duplicateBtn = document.getElementById('duplicateBtn');

      if (readOnly) {
        saveBtn.style.display = 'none';
        duplicateBtn.style.display = 'none';
      } else {
        saveBtn.style.display = 'block';
        saveBtn.textContent = 'üíæ Actualizar Evaluaci√≥n';
        saveBtn.onclick = updateEvaluation;
        duplicateBtn.style.display = 'none';
      }

      // Show panel
      document.getElementById('evaluationPanel').classList.add('active');
      document.getElementById('evaluationPanelOverlay').classList.add('active');
    }

    /**
     * Update existing evaluation
     */
    async function updateEvaluation() {
      try {
        const instrument = evaluationData.reviewData.selectedInstrument;
        const originalEvaluation = window.currentReviewEvaluation;
        const notes = document.getElementById('evaluationNotes')?.value || '';

        let evaluationResult;

        if (instrument.tipo === 'R√∫brica') {
          evaluationResult = collectRubricData();
        } else if (instrument.tipo === 'Lista de Cotejo') {
          evaluationResult = collectChecklistData();
        } else if (instrument.tipo === 'Calificaci√≥n Directa') {
          evaluationResult = collectDirectGradeData();
        }

        if (!evaluationResult) {
          showError('Por favor, completa todos los campos requeridos');
          return;
        }

        showLoading('Actualizando evaluaci√≥n...');

        const updatePayload = {
          studentId: originalEvaluation.studentId,
          studentName: originalEvaluation.studentName,
          instrumentId: instrument.id,
          instrumentName: instrument.nombre,
          instrumentType: instrument.tipo,
          course: evaluationData.reviewData.selectedCourse,
          situacion: instrument.situacionAprendizaje,
          resultado: evaluationResult,
          notas: notes,
          isUpdate: true
        };

        await callBackend('updateEvaluation', updatePayload);

        hideLoading();
        showSuccess('Evaluaci√≥n actualizada correctamente');

        // Close panel and refresh list
        closeEvaluationPanel();
        await loadReviewEvaluations();

      } catch (error) {
        hideLoading();
        console.error('Error updating evaluation:', error);
        showError('Error al actualizar evaluaci√≥n', error.message);
      }
    }

    // ============================================================================
    // END EVALUATION SECTION
    // ============================================================================

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeDashboard);
    } else {
      // DOM already loaded
      initializeDashboard();
    }

    // ============================================================================
    // UTILITY: OPEN IN NEW WINDOW (for modal mode)
    // ============================================================================

    /**
     * Open dashboard in new window (only works from modal mode)
     */
    async function openDashboardInNewWindow() {
      if (!isModalMode) {
        showError('Ya est√°s en modo ventana independiente');
        return;
      }

      try {
        showLoading('Abriendo dashboard en nueva ventana...');
        const url = await callBackend('getWebAppUrl');
        hideLoading();

        const finalUrl = url + '?view=dashboard';
        window.open(finalUrl, '_blank', 'width=1400,height=900');
        showSuccess('Dashboard abierto en nueva ventana');
      } catch (err) {
        hideLoading();
        showError('Error al abrir en nueva ventana', err.message);
      }
    }

    // Log any unhandled errors
    window.addEventListener('error', (event) => {
      console.error('Unhandled error:', event.error);
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
    });
  </script>
</body>

</html>