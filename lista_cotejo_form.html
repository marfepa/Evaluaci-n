<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>Evaluar Lista de Cotejo: <?!= instrumentoNombre ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
    .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { color: #0056b3; text-align: center; margin-bottom: 25px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; color: #555; }
    select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .item-section { background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 5px; padding: 15px; margin-bottom: 20px; }
    .item-section[data-item-id] { position: relative; }
    .item-description { font-weight: bold; margin-bottom: 10px; color: #003a6c; }
    .item-options-buttons { display: flex; gap: 10px; margin-top: 10px; }
    .option-button {
      flex: 1;
      background-color: #f0f0f0;
      color: #333;
      padding: 15px;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
      font-size: 1.1em;
      transition: background-color 0.3s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 50px;
      box-sizing: border-box;
    }
    .option-button:hover { background-color: #e0e0e0; border-color: #999; }
    input[type="radio"] { display: none; }
    input[type="radio"]:checked + .option-button {
      background-color: #007bff;
      color: white;
      border-color: #0056b3;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.5);
    }
    input[type="radio"][value="No"]:checked + .option-button {
      background-color: #dc3545;
      border-color: #bd2130;
      box-shadow: 0 0 0 3px rgba(220,53,69,0.5);
    }
    #saveBtn {
      background-color: #28a745;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
      transition: background-color 0.3s ease;
    }
    #saveBtn:hover { background-color: #218838; }
    #saveBtn:disabled { opacity: 0.7; cursor: not-allowed; }
    .feedback { margin-top: 20px; padding: 10px; border-radius: 5px; display: none; }
    .feedback.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .feedback.error   { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Evaluar Lista de Cotejo: <?!= instrumentoNombre ?></h1>
    <form id="listaCotejoForm">
      <input type="hidden" id="instrumentoIdHidden" value="<?!= instrumentoID ?>">

      <label for="studentSelect">Selecciona un Estudiante:</label>
      <select id="studentSelect" name="studentId" required>
        <option value="">-- Selecciona un Estudiante --</option>
        <? estudiantes.forEach(function(student) { ?>
         <option 
           value="<?!= student.IDEstudiante ?>" 
           data-course="<?!= student.CursoID ?>" 
           data-group="<?!= student.ColegioID ?>">
           <?!= student.NombreEstudiante ?> (<?!= student.CursoID ?>)
         </option>
       <? }) ?>
      </select>

      <? listaCotejo.items.forEach(function(item) { ?>
        <div class="item-section" data-item-id="<?!= item.IDItem ?>">
          <div class="item-description"><?!= item.DescripcionItem ?></div>
          <div class="item-options-buttons">
            <input type="radio" id="item_<?!= item.IDItem ?>_si" name="item_<?!= item.IDItem ?>" value="Sí" required>
            <label for="item_<?!= item.IDItem ?>_si" class="option-button">Sí</label>

            <input type="radio" id="item_<?!= item.IDItem ?>_no" name="item_<?!= item.IDItem ?>" value="No">
            <label for="item_<?!= item.IDItem ?>_no" class="option-button">No</label>
          </div>
        </div>
      <? }) ?>

      <label for="comments">Comentarios Generales (Opcional):</label>
      <textarea id="comments" name="comments" rows="4"></textarea>

      <button type="button" id="saveBtn">Guardar Evaluación</button>
    </form>
    <div id="feedback" class="feedback"></div>
  </div>

  <script>
    document.getElementById('saveBtn').addEventListener('click', function(event) {
      event.preventDefault();

      const select = document.getElementById('studentSelect');
      const opt = select.options[select.selectedIndex];
      if (!opt.value) {
        alert('Por favor selecciona un estudiante.');
        return;
      }

      // Recopilar ítems con for…of
      const items = [];
      const sections = document.querySelectorAll('.item-section');
      for (const section of sections) {
        const id = section.dataset.itemId;
        const radio = section.querySelector('input[type="radio"]:checked');
        if (!radio) {
          alert('Por favor evalúa todos los ítems.');
          return;
        }
        items.push({
          itemID: id,
          completado: radio.value === 'Sí'
        });
      }

      const formData = {
        instrumentoId: document.getElementById('instrumentoIdHidden').value,
        studentId: opt.value,
        studentCourse: opt.dataset.course,
        studentGroup: opt.dataset.group,
        items: items,
        comments: document.getElementById('comments').value || ''
      };

      const fb = document.getElementById('feedback');
      const btn = document.getElementById('saveBtn');
      fb.style.display = 'block';
      fb.className = 'feedback';
      fb.textContent = 'Guardando evaluación...';
      btn.disabled = true;

      google.script.run
        .withSuccessHandler(function(res) {
          alert(res.message);
          fb.className = 'feedback success';
          fb.textContent = res.message;
          document.getElementById('listaCotejoForm').reset();
          btn.disabled = false;
        })
        .withFailureHandler(function(err) {
          fb.className = 'feedback error';
          fb.textContent = 'Error: ' + err.message;
          btn.disabled = false;
        })
        .recordListaCotejoGrade(formData);
    });
  </script>
</body>
</html>
