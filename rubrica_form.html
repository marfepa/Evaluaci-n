<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base target="_top">
  <title>R√∫brica: <?!= instrumentoNombre ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Estilos adaptados */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    .container {
      max-width: 95%;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }
    h1 {
      color: #667eea;
      font-size: 1.8em;
      margin: 0;
    }
    .form-section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 8px;
      color: #495057;
    }
    select,
    textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    .rubrica-table {
      width: 100%;
      border-collapse: collapse;
      margin: 25px 0;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .rubrica-table th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #ffffff;
      padding: 15px 10px;
      text-align: center;
      font-weight: bold;
    }
    .rubrica-table td {
      border: 1px solid #dee2e6;
      padding: 15px;
      text-align: center;
      vertical-align: top;
    }
    .criterio-cell {
      text-align: left !important;
      background: #e3f2fd;
      font-weight: bold;
      color: #1565c0;
    }
    .radio-container {
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      padding: 10px;
    }
    .radio-container:hover {
      background-color: #f0f8ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    input[type='radio'] { display: none; }
    input[type='radio']:checked + .radio-label {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: #fff;
      transform: scale(1.02);
    }
    .radio-label {
      display: block;
      padding: 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .nivel-nombre { font-weight: bold; font-size: 1.1em; margin-bottom: 8px; }
    .nivel-descriptor { font-size: 0.9em; margin: 8px 0; line-height: 1.4; color: #333; }
    .nivel-puntos { font-weight: bold; color: #007bff; font-size: 1.1em; margin-top: 8px; }
    .submit-section {
      background: linear-gradient(135deg, #28a745, #20c997);
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      margin-top: 30px;
    }
    .submit-button {
      background: #fff;
      color: #28a745;
      border: none;
      border-radius: 8px;
      padding: 15px 40px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .submit-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); }
    .submit-button:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
    .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; display: none; }
    .feedback.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .feedback.error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>R√∫brica: <?!= instrumentoNombre ?></h1>
    </div>
    <form id="rubricForm">
      <input type="hidden" name="instrumentoID" value="<?!= instrumentoID ?>">
      <div class="form-section">
        <label for="studentSelect">Selecciona Estudiante:</label>
        <select id="studentSelect" name="studentId" required>
          <option value="">-- Selecciona un Estudiante --</option>
          <? estudiantes.forEach(function(s){ ?>
            <option value="<?!= s.IDEstudiante ?>"><?!= s.NombreEstudiante ?></option>
          <? }) ?>
        </select>
      </div>
      <table class="rubrica-table">
        <thead>
          <tr>
            <th>Criterio</th>
            <? rubrica.niveles.forEach(function(n){ ?>
              <th><?!= n.Nombre ?> <small>(<?!= n.Puntuacion ?> pts)</small></th>
            <? }) ?>
          </tr>
        </thead>
        <tbody>
          <? rubrica.criterios.forEach(function(c){ ?>
            <tr data-criterio-id="<?!= c.ID ?>">
              <td class="criterio-cell"><?!= c.Nombre ?></td>
              <? rubrica.niveles.forEach(function(n){ 
                   var descObj   = c.DescriptoresPorNivel.find(function(d){ return d.NivelID===n.ID; }) || {};
                   var descriptor = descObj.Descriptor || '';
              ?>
                <td>
                  <input type="radio"
                         name="criterio_<?!= c.ID ?>"
                         id="c_<?!= c.ID ?>_n_<?!= n.ID ?>"
                         value="<?!= n.ID ?>"
                         data-puntuacion="<?!= n.Puntuacion ?>"
                         required>
                  <label for="c_<?!= c.ID ?>_n_<?!= n.ID ?>" class="radio-label">
                    <div class="nivel-nombre"><?!= n.Nombre ?></div>
                    <div class="nivel-descriptor"><?!= descriptor ?></div>
                    <div class="nivel-puntos"><?!= n.Puntuacion ?> pts</div>
                  </label>
                </td>
              <? }) ?>
            </tr>
          <? }) ?>
        </tbody>
      </table>
      <div class="form-section">
        <label for="comments">Comentarios Generales:</label>
        <textarea id="comments" name="comments" rows="4"></textarea>
      </div>
      <div class="submit-section">
        <button type="button" id="saveButton" class="submit-button" onclick="submitForm()">üíæ Guardar Evaluaci√≥n</button>
      </div>
    </form>
    <div id="feedback" class="feedback"></div>
  </div>
  <script>
    // Cargar evaluaci√≥n existente cuando se selecciona un estudiante
    document.getElementById('studentSelect').addEventListener('change', function() {
      const studentId = this.value;
      const instrumentoID = document.querySelector('input[name="instrumentoID"]').value;

      if (!studentId) {
        // Limpiar formulario si no hay estudiante seleccionado
        document.querySelectorAll('input[type="radio"]:checked').forEach(radio => radio.checked = false);
        document.getElementById('comments').value = '';
        return;
      }

      // Buscar evaluaci√≥n existente
      const fb = document.getElementById('feedback');
      fb.style.display = 'block';
      fb.className = 'feedback';
      fb.textContent = 'Cargando evaluaci√≥n existente...';

      google.script.run
        .withSuccessHandler(function(result) {
          fb.style.display = 'none';

          if (result.success && result.data) {
            // Marcar los radio buttons correspondientes
            Object.keys(result.data.criterios).forEach(criterioId => {
              const nivelId = result.data.criterios[criterioId];
              const radioId = 'c_' + criterioId + '_n_' + nivelId;
              const radio = document.getElementById(radioId);
              if (radio) {
                radio.checked = true;
                // Aplicar estilo visual
                radio.parentElement.querySelector('.radio-label').style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                radio.parentElement.querySelector('.radio-label').style.color = '#fff';
              }
            });

            // Cargar comentarios
            if (result.data.comentarios) {
              document.getElementById('comments').value = result.data.comentarios;
            }

            // Mostrar mensaje de evaluaci√≥n existente
            fb.style.display = 'block';
            fb.className = 'feedback success';
            fb.textContent = '‚úÖ Evaluaci√≥n existente cargada';
            setTimeout(() => { fb.style.display = 'none'; }, 3000);
          } else {
            // No hay evaluaci√≥n previa, limpiar formulario
            document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
              radio.checked = false;
              // Limpiar estilos
              const label = radio.parentElement.querySelector('.radio-label');
              if (label) {
                label.style.background = '';
                label.style.color = '';
              }
            });
            document.getElementById('comments').value = '';
          }
        })
        .withFailureHandler(function(err) {
          fb.className = 'feedback error';
          fb.textContent = '‚ö†Ô∏è Error al cargar evaluaci√≥n: ' + err.message;
          setTimeout(() => { fb.style.display = 'none'; }, 3000);
        })
        .getExistingRubricaEvaluation(instrumentoID, studentId);
    });

    function submitForm(){
      const instrumentoID = document.querySelector('input[name="instrumentoID"]').value;
      const studentSelect = document.getElementById('studentSelect');
      if(!studentSelect.value){ alert('Selecciona un estudiante.'); return; }
      const criterios=[];
      for(const row of document.querySelectorAll('tr[data-criterio-id]')){
        const critID = row.getAttribute('data-criterio-id');
        const radio = row.querySelector('input[type="radio"]:checked');
        if(!radio){ alert('Eval√∫a todos los criterios.'); return; }
        criterios.push({criterioID:critID,nivelID:radio.value,puntuacion:parseFloat(radio.dataset.puntuacion)});
      }
      const data={instrumentoID,studentId:studentSelect.value,criterios,rubricaMaxPuntuacionPosible:<?!=rubrica.maxPuntuacionPosible?>,comments:document.getElementById('comments').value||''};
      const fb=document.getElementById('feedback'),btn=document.getElementById('saveButton');
      fb.style.display='block';fb.className='feedback';fb.textContent='Guardando‚Ä¶';btn.disabled=true;
      google.script.run.withSuccessHandler(res=>{fb.className='feedback success';fb.textContent='‚úÖ Guardado';document.getElementById('rubricForm').reset();btn.disabled=false;})
                         .withFailureHandler(err=>{fb.className='feedback error';fb.textContent='‚ùå '+err.message;btn.disabled=false;})
                         .recordRubricaGrade(data);
    }
  </script>
</body>
</html>
